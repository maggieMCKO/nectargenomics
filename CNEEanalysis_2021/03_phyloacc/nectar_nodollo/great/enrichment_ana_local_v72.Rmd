---
title: "GREAT R Notebook - 20240724"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

## set up
```{r, setup=TRUE, include=FALSE}

setwd(paste0(getwd(), '/Seq_Data/globus/CNEEanalysis_2021/03_phyloacc/2024ver/nectar_nodollo/great/'))
# out_dir = "plotsv7/"
out_dir = "plotsv72/"
dir.create(out_dir)

library(tidyverse)
library(janitor)
# library(readxl) # gwdg not installed
library(RColorBrewer)
library(GOfuncR)
# BiocManager::install("simplifyEnrichment")
library(simplifyEnrichment)
library(GO.db)
library(GOSemSim)

# gwdg
FontSize = 2.5 *2
AxisTxFontSizeSize = 6 *2
AxisTxFontSizeSize_s = 5 *2
AxisTitleFontSizeSize = 6 *2

Factor_mmtoin = 0.0393701
Width_HalfCol = 85*Factor_mmtoin 

theme_m = theme(panel.background = element_blank(),
                plot.background = element_blank(), # defualt is white
                plot.title = element_text(colour = "black", size = AxisTitleFontSizeSize, hjust = 0.5),
                plot.margin = margin(0.5, 2, 0.5, 0.5, "line"),
                panel.grid = element_blank(),
                panel.border = element_rect(color = "black", fill= NA, linewidth =.2), 
                axis.title.x = element_text(colour = "black", size = AxisTitleFontSizeSize, hjust = 0.5),
                axis.title.y = element_text(colour = "black", size = AxisTitleFontSizeSize),
                axis.text.x = element_text(colour = "black", size = AxisTxFontSizeSize),
                axis.text.y = element_text(colour = "black", size = AxisTxFontSizeSize),
                axis.ticks = element_line(colour = "black", linewidth = 0.05),
                strip.text = element_text(colour = "black", size = AxisTxFontSizeSize),
                legend.background = element_blank(),
                legend.key = element_blank(),
                legend.key.size = unit(8, "pt"),
                legend.title = element_blank(),
                legend.text = element_text(colour = "black", size = AxisTxFontSizeSize))

theme_tile =   theme(panel.grid = element_blank(), 
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 6, angle = 90, hjust = 1, vjust = 0.5),
        axis.text.y = element_text(size = 6), 
        strip.text = element_text(size = 6), 
        legend.key.size = unit(8, 'pt'),
        legend.text = element_text(size = 6),
        legend.title = element_text(size = 6))

theme_a = theme_bw() + 
  theme(panel.background = element_blank(),
        plot.background = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 50, vjust = 1, hjust = 1),
        axis.text.y = element_text(hjust = 1),
        panel.grid = element_blank(),
        legend.key.size = unit(8, "pt"),
        legend.background = element_blank(),
        # legend.title = element_text(size = 6),
        legend.position = "right")

present = function(s){ifelse(!is.na(s), 1, 0)}
```


# A. load files
## 1. load gene cnee assignment (protein-coding only & basalPlusExtension )
### all cnee
```{r}
allcnee_great = read_tsv(paste0(getwd(), "/overlap/cnee_gene_assignment_basalPlusExtension_proteincoding_allcnees.bed"), 
                        col_names = c("chr", "start", "end", "id", "chr2", "start2", "end2", "gene")) %>% 
      mutate(gene = gsub("LOC107051846", "IRS1", gene),
           gene = gsub("LOC107055431", "NEDD4L", gene),
           gene = gsub("gga-mir-6690", "CTSB", gene),
           gene = gsub("gga-mir-12216", "B2M", gene),
           gene = gsub("gga-mir-12230", "SLC27A4", gene),
           gene = gsub("^Ii$", "CD74", gene))
n_distinct(allcnee_great$gene) # 12410

allcnee_great2 = allcnee_great %>% 
  dplyr::select(id, gene) %>% distinct()
n_distinct(allcnee_great2$gene) # 12410
path = paste0(getwd(), "/overlap/cnee_gene_assignment_basalPlusExtension_proteincoding_allcnees_m.bed")
# write_tsv(allcnee_great2, file = path)

allabsrelinput = read_tsv("/Users/mbp23/ownCloud/Baldwin/Projects/Nectar/Seq_Data/globus/CNEEanalysis_2021/old_code/05_perm_phyloacc/1_rmPar/previous_materials/katya_new_chicken_anno/validated.final.isoformes.galGal6.ncbi_appris.tsv", col_names = c("gene", "transcript"))
# n_distinct(allabsrelinput$gene)
# l = list('all cnee-gene' = allcnee_great$gene, 'absrel input' = allabsrelinput$gene)
# ggvenn::ggvenn(l)
# setdiff(allcnee_great$gene, allabsrelinput$gene)
# setdiff(allabsrelinput$gene, allcnee_great$gene)

# load custom annotation
# path = paste0("/home/mpg08/mko/Nectar/analysis/CNEEanalysis_2021/05_perm_phyloacc/1_rmPar/validated.final.isoformes.galGal6.ncbi_appris_kegg_go_hsa_2022-11-21.tsv")
path = paste0(getwd(), "/../../../../00_inputs/validated.final.isoformes.galGal6.ncbi_appris_kegg_go_hsa_2022-11-21.tsv")
kegg_go_anno = read_tsv(path) 
go_annoC = kegg_go_anno %>% filter(!is.na(go_id)) %>%
  dplyr::select(gene, go_id, goTerm, ont) %>%
  filter(!is.na(gene)) %>%
  distinct() %>% 
  mutate(go_id = gsub(":", "_", go_id)) %>% 
  mutate(gene = gsub("LOC107051846", "IRS1", gene),
         gene = gsub("LOC107055431", "NEDD4L", gene),
         gene = gsub("gga-mir-6690", "CTSB", gene),
         gene = gsub("gga-mir-12216", "B2M", gene),
         gene = gsub("gga-mir-12230", "SLC27A4", gene),
         gene = gsub("^Ii$", "CD74", gene))
dim(go_annoC) # 325923      4
n_distinct(go_annoC$gene) # 15596
n_distinct(go_annoC$go_id) # 17917
# go_annoC %>% group_by(ont) %>% summarise(n = n_distinct(go_id)) # ignore NA
# 1 biological_process 11876
# 2 cellular_component  1783
# 3 molecular_function  4239
# 4 NA                    19
# x = go_annoC %>% filter(is.na(ont))
rm(kegg_go_anno)

n_distinct(go_annoC$go_id) # 17917

# keep go_id with >= 40 genes in universee
# 1. this is based on annotation
# go_annoC_filtered = go_annoC %>% group_by(go_id) %>% 
#   mutate(n_genes = n_distinct(gene)) %>% 
#   filter(n_genes >= 40)
# n_distinct(go_annoC_filtered$go_id) # 1141
# go_annoC_filtered_pathwayonly = go_annoC_filtered %>% dplyr::select(-gene) %>% distinct()

# 2. this is based on genes with association with cnees
go_annoC_filtered = go_annoC %>% 
  filter(gene %in% allcnee_great$gene) %>% 
  group_by(go_id) %>% 
  mutate(n_genes = n_distinct(gene)) %>% 
  filter(n_genes >= 40)
n_distinct(go_annoC_filtered$go_id) # 776
go_annoC_filtered_pathwayonly = go_annoC_filtered %>% dplyr::select(-gene) %>% distinct()
# compare 1 and 2
# go_annoC_filtered_pathwayonly_only = go_annoC_filtered_pathwayonly %>% 
#   filter(!go_id %in% go_annoC_filtered_pathwayonly$go_id)
# filtered out
go_annoC_counts = go_annoC %>% 
  filter(ont == "biological_process") %>% 
  filter(gene %in% allcnee_great$gene) %>% 
  group_by(go_id) %>% 
  mutate(n_genes = n_distinct(gene)) %>% dplyr::select(-gene) %>% distinct()
x = go_annoC %>% 
  filter(gene %in% allcnee_great$gene) %>% 
  group_by(go_id) %>% 
  mutate(n_genes = n_distinct(gene)) %>% 
  filter(n_genes < 40) %>% dplyr::select(-gene) %>% distinct()

# go_id and gene
go_annoCm = go_annoC %>% 
    mutate(go_id = gsub("_", ":", go_id)) %>% 
    dplyr::select(-ont, -goTerm) %>% 
    distinct()

get_cneegene_4clades = function(input_acc_criteria){
  if(input_acc_criteria == "Loose"){
    acccnees_to_path = acccnees_100kb_withcnees0_loose_sel 
  }else if(input_acc_criteria == "NarrowBF2_gt2"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow2_sel 
  } else if(input_acc_criteria == "NarrowBF2_gt3"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow3_sel 
  }else if(input_acc_criteria == "ControlLoose"){
    acccnees_to_path = acccnees_100kb_withcnees0_looseCon_sel 
  } else if(input_acc_criteria == "ControlNarrowBF2_gt2"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow2Con_sel
  } else if(input_acc_criteria == "ControlNarrowBF2_gt3"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow3Con_sel
    return(acccnees_to_path)
  }
}

```

### Nectar
#### Loose
```{r}
target_file = list.files(paste0(getwd(), "/overlap/Loose/"), 
                         ".*_basalPlusExtension_\\w+_v72.bed", full.names = T); target_file # great default assign rule

acccnees_100kb_withcnees0_loose = lapply(target_file, function(s){
  # s = target_file[1]
  tmp_name = basename(s)
  tmp_name = gsub("cnee_gene_assignment_basalPlusExtension_proteincoding_Loose_", "", tmp_name)
  tmp_name = gsub("_v72.bed", "", tmp_name)
  print(paste0("current: ", tmp_name))
  x = read_tsv(s, col_names = c("chr", "start", "end", "id", "chr2", "start2", "end2", "gene")) %>% 
    dplyr::select(gene, id) %>%
    bind_cols('group' = tmp_name) 
}) %>% bind_rows()  %>% 
  # mutate(group = gsub("_2", "", group)) %>% 
  mutate(group = gsub("sunbirds_flowerpecker", "sunbirds", group)) %>% 
  mutate(gene = gsub("LOC107051846", "IRS1", gene),
         gene = gsub("LOC107055431", "NEDD4L", gene),
         gene = gsub("gga-mir-6690", "CTSB", gene),
         gene = gsub("gga-mir-12216", "B2M", gene),
         gene = gsub("gga-mir-12230", "SLC27A4", gene),
         gene = gsub("^Ii$", "CD74", gene))
head(acccnees_100kb_withcnees0_loose)

acccnees_100kb_withcnees_loose = acccnees_100kb_withcnees0_loose %>% 
  mutate(set = paste0("acc_", group), 
         val = 1,
         analysis = "acc") %>% 
  dplyr::select(set, gene, val, analysis, group) %>% 
  distinct()
dim(acccnees_100kb_withcnees_loose) # 27977    5
head(acccnees_100kb_withcnees_loose)
# set                gene     val analysis group    
# acc_2wayconvergent KLHL1      1 acc      congvergent2way
# acc_2wayconvergent PLXNA4     1 acc      congvergent2way
unique(acccnees_100kb_withcnees_loose$group)

## keep only sets of 4 cloades
acccnees_100kb_withcnees0_loose_sel = acccnees_100kb_withcnees0_loose %>%
  filter(group %in% c("honeyeaters", "hummingbirds", "parrots", "sunbirds" )) %>% 
  dplyr::rename(clade = group)
  
unique(acccnees_100kb_withcnees0_loose_sel$clade)

acccnees_100kb_withcnees0_loose_selb = acccnees_100kb_withcnees0_loose_sel %>% 
  dplyr::select(clade, gene) %>% distinct()

```

num genes
```{r, fig.height=3, fig.width=4}

nectar_clade_order = c("hummingbirds", "parrots", "honeyeaters", "sunbirds")
nectar_clade_order_union = c("union", nectar_clade_order)
n_union = n_distinct(acccnees_100kb_withcnees0_loose_selb$gene) # 2251 <- union

p_loose = acccnees_100kb_withcnees0_loose_selb %>% 
  group_by(clade) %>% tally() %>%
  bind_rows(tibble(clade = "union", n = n_union)) %>% 
  ggplot(aes(x = fct_relevel(clade, nectar_clade_order_union), y = n)) +
  geom_col() + 
  geom_text(aes(label = n), vjust = 0, size = 2*2) +
  # facet_grid(.~bf) + 
  # scale_x_discrete(name = "logBFx >= n") +
  scale_y_continuous(expand = c(0,0,0.05,0), name = "gene count") + theme_m +
  ggtitle('Loose') +
  theme(axis.title.x = element_blank()); p_loose

```


#### Narrow BF2_gt3 (skip 20240910)
```{r}
target_file = list.files(paste0(getwd(), "/overlap/NarrowBF2_gt3/"), 
                         ".*_basalPlusExtension_\\w+.bed", full.names = T); target_file # great default assign rule

acccnees_100kb_withcnees0_narrow3 = lapply(target_file, function(s){
  # s = target_file[1]
  tmp_name = basename(s)
  tmp_name = gsub("cnee_gene_assignment_basalPlusExtension_proteincoding_NarrowBF2_gt3_", "", tmp_name)
  tmp_name = gsub(".bed", "", tmp_name)
  print(paste0("current: ", tmp_name))
  x = read_tsv(s, col_names = c("chr", "start", "end", "id", "chr2", "start2", "end2", "gene")) %>% 
    dplyr::select(gene, id) %>%
    bind_cols('group' = tmp_name) 
}) %>% bind_rows()  %>% 
  # mutate(group = gsub("_2", "", group)) %>% 
  mutate(group = gsub("sunbirds_flowerpecker", "sunbirds", group)) %>% 
  mutate(gene = gsub("LOC107051846", "IRS1", gene),
         gene = gsub("LOC107055431", "NEDD4L", gene),
         gene = gsub("gga-mir-6690", "CTSB", gene),
         gene = gsub("gga-mir-12216", "B2M", gene),
         gene = gsub("gga-mir-12230", "SLC27A4", gene),
         gene = gsub("^Ii$", "CD74", gene))
head(acccnees_100kb_withcnees0_narrow3)

acccnees_100kb_withcnees_narrow3 = acccnees_100kb_withcnees0_narrow3 %>% 
  mutate(set = paste0("acc_", group), 
         val = 1,
         analysis = "acc") %>% 
  dplyr::select(set, gene, val, analysis, group) %>% 
  distinct()
dim(acccnees_100kb_withcnees_narrow3) # 7559    5
head(acccnees_100kb_withcnees_narrow3)
# set                gene     val analysis group    
# acc_2wayconvergent KLHL1      1 acc      congvergent2way
# acc_2wayconvergent PLXNA4     1 acc      congvergent2way
unique(acccnees_100kb_withcnees_narrow3$group)

## keep only sets of 4 cloades
acccnees_100kb_withcnees0_narrow3_sel = acccnees_100kb_withcnees0_narrow3 %>%
  filter(group %in% c("honeyeaters", "hummingbirds", "parrots", "sunbirds" )) %>% 
  dplyr::rename(clade = group)
  
unique(acccnees_100kb_withcnees0_narrow3_sel$clade)

acccnees_100kb_withcnees0_narrow3_selb = acccnees_100kb_withcnees0_narrow3_sel %>% 
  dplyr::select(clade, gene) %>% distinct()

```

num genes
```{r, fig.height=3, fig.width=4}

nectar_clade_order = c("hummingbirds", "parrots", "honeyeaters", "sunbirds")
nectar_clade_order_union = c("union", nectar_clade_order)
n_union = n_distinct(acccnees_100kb_withcnees0_narrow3_selb$gene) # 2251 <- union

p_narrow3 = acccnees_100kb_withcnees0_narrow3_selb %>% 
  group_by(clade) %>% tally() %>%
  bind_rows(tibble(clade = "union", n = n_union)) %>% 
  ggplot(aes(x = fct_relevel(clade, nectar_clade_order_union), y = n)) +
  geom_col() + 
  geom_text(aes(label = n), vjust = 0, size = 2*2) +
  # facet_grid(.~bf) + 
  # scale_x_discrete(name = "logBFx >= n") +
  scale_y_continuous(expand = c(0,0,0.05,0), name = "gene count") + theme_m +
  ggtitle('Narrow (logBF2 > 3)') +
  theme(axis.title.x = element_blank()); p_narrow3

```


num genes both sets
```{r, fig.height=3, fig.width=10}
p = cowplot::plot_grid(p_loose, p_narrow3, nrow = 1); p
```

#### convergence
```{r, fig.height=3, fig.width=10}
# acccnees_100kb_withcnees0_loose_selb

loose_sum = acccnees_100kb_withcnees0_loose_selb %>% 
  group_by(gene) %>% 
  summarise(n_clade = n_distinct(clade)) %>% 
  group_by(n_clade) %>% 
  tally() %>% bind_cols('set' = 'Loose')

narrow3_sum = acccnees_100kb_withcnees0_narrow3_selb %>% 
  group_by(gene) %>% 
  summarise(n_clade = n_distinct(clade)) %>% 
  group_by(n_clade) %>% 
  tally() %>% bind_cols('set' = 'Narrow3')

p_loose = loose_sum %>% 
  ggplot(aes(x = n_clade, y = n)) +
  geom_col() +
  geom_text(aes(label = n), vjust = 0) +
  scale_y_continuous(expand = c(0,0,0.05,0), name = 'num genes') +
  ggtitle('Loose set') +
  theme_m; p_loose

p_narrow3 = narrow3_sum %>% 
  ggplot(aes(x = n_clade, y = n)) +
  geom_col() +
  geom_text(aes(label = n), vjust = 0) +
  scale_y_continuous(expand = c(0,0,0.05,0), name = 'num genes') +
  ggtitle('Narrow (logBF2 > 3)') +
  theme_m; p_narrow3

p = cowplot::plot_grid(p_loose, p_narrow3, nrow = 1); p
```

### control
#### ControlLoose
```{r}
control_path = "/Users/mbp23/ownCloud/Baldwin/Projects/Nectar/Seq_Data/globus/CNEEanalysis_2021/03_phyloacc/2024ver/control_nodollo/great/"

target_file = list.files(paste0(control_path, "/overlap/ControlLoose/"), 
                         ".*_basalPlusExtension_\\w+_v72.bed", full.names = T); target_file # great default assign rule

acccnees_100kb_withcnees0_looseCon = lapply(target_file, function(s){
  # s = target_file[1]
  tmp_name = basename(s)
  tmp_name = gsub("cnee_gene_assignment_basalPlusExtension_proteincoding_ControlLoose_", "", tmp_name)
  tmp_name = gsub("_v72.bed", "", tmp_name)
  print(paste0("current: ", tmp_name))
  x = read_tsv(s, col_names = c("chr", "start", "end", "id", "chr2", "start2", "end2", "gene")) %>% 
    dplyr::select(gene, id) %>%
    bind_cols('group' = tmp_name) 
}) %>% bind_rows()  %>% 
  # mutate(group = gsub("_2", "", group)) %>% 
  mutate(group = gsub("sunbirds_flowerpecker", "sunbirds", group)) %>% 
  mutate(gene = gsub("LOC107051846", "IRS1", gene),
         gene = gsub("LOC107055431", "NEDD4L", gene),
         gene = gsub("gga-mir-6690", "CTSB", gene),
         gene = gsub("gga-mir-12216", "B2M", gene),
         gene = gsub("gga-mir-12230", "SLC27A4", gene),
         gene = gsub("^Ii$", "CD74", gene))
head(acccnees_100kb_withcnees0_looseCon)

acccnees_100kb_withcnees_looseCon = acccnees_100kb_withcnees0_looseCon %>% 
  mutate(set = paste0("acc_", group), 
         val = 1,
         analysis = "acc") %>% 
  dplyr::select(set, gene, val, analysis, group) %>% 
  distinct()
dim(acccnees_100kb_withcnees_looseCon) # 12290    5
head(acccnees_100kb_withcnees_looseCon)
# set                gene     val analysis group    
# acc_2wayconvergent KLHL1      1 acc      congvergent2way
# acc_2wayconvergent PLXNA4     1 acc      congvergent2way
unique(acccnees_100kb_withcnees_looseCon$group)

## keep only sets of 4 cloades
acccnees_100kb_withcnees0_looseCon_sel = acccnees_100kb_withcnees0_looseCon %>%
  filter(group %in% c("swifts", "falcons", "lyrebirds", "passerides" )) %>% 
  dplyr::rename(clade = group)
  
unique(acccnees_100kb_withcnees0_looseCon_sel$clade)

acccnees_100kb_withcnees0_looseCon_selb = acccnees_100kb_withcnees0_looseCon_sel %>% 
  dplyr::select(clade, gene) %>% distinct()

```

num genes
```{r, fig.height=3, fig.width=4}

nonnectar_clade_order = c("swifts", "falcons", "lyrebirds", "passerides" )
nonnectar_clade_order_union = c("union", nonnectar_clade_order)
n_union = n_distinct(acccnees_100kb_withcnees0_looseCon_selb$gene) # 2251 <- union

p_looseCon = acccnees_100kb_withcnees0_looseCon_selb %>% 
  group_by(clade) %>% tally() %>%
  bind_rows(tibble(clade = "union", n = n_union)) %>% 
  ggplot(aes(x = fct_relevel(clade, nonnectar_clade_order_union), y = n)) +
  geom_col() + 
  geom_text(aes(label = n), vjust = 0, size = 2*2) +
  # facet_grid(.~bf) + 
  # scale_x_discrete(name = "logBFx >= n") +
  scale_y_continuous(expand = c(0,0,0.05,0), name = "gene count") + theme_m +
  ggtitle('Loose') +
  theme(axis.title.x = element_blank()); p_looseCon

```

#### Narrow BF2_gt3 (skip 20240910)
```{r}
target_file = list.files(paste0(control_path, "/overlap/ControlNarrowBF2_gt3/"), 
                         ".*_basalPlusExtension_\\w+.bed", full.names = T); target_file # great default assign rule

acccnees_100kb_withcnees0_narrow3Con = lapply(target_file, function(s){
  # s = target_file[1]
  tmp_name = basename(s)
  tmp_name = gsub("cnee_gene_assignment_basalPlusExtension_proteincoding_ControlNarrowBF2_gt3_", "", tmp_name)
  tmp_name = gsub(".bed", "", tmp_name)
  print(paste0("current: ", tmp_name))
  x = read_tsv(s, col_names = c("chr", "start", "end", "id", "chr2", "start2", "end2", "gene")) %>% 
    dplyr::select(gene, id) %>%
    bind_cols('group' = tmp_name) 
}) %>% bind_rows()  %>% 
  # mutate(group = gsub("_2", "", group)) %>% 
  mutate(group = gsub("sunbirds_flowerpecker", "sunbirds", group)) %>% 
  mutate(gene = gsub("LOC107051846", "IRS1", gene),
         gene = gsub("LOC107055431", "NEDD4L", gene),
         gene = gsub("gga-mir-6690", "CTSB", gene),
         gene = gsub("gga-mir-12216", "B2M", gene),
         gene = gsub("gga-mir-12230", "SLC27A4", gene),
         gene = gsub("^Ii$", "CD74", gene))
head(acccnees_100kb_withcnees0_narrow3Con)

acccnees_100kb_withcnees_narrow3Con = acccnees_100kb_withcnees0_narrow3Con %>% 
  mutate(set = paste0("acc_", group), 
         val = 1,
         analysis = "acc") %>% 
  dplyr::select(set, gene, val, analysis, group) %>% 
  distinct()
dim(acccnees_100kb_withcnees_narrow3Con) # 7559    5
head(acccnees_100kb_withcnees_narrow3Con)
# set                gene     val analysis group    
# acc_2wayconvergent KLHL1      1 acc      congvergent2way
# acc_2wayconvergent PLXNA4     1 acc      congvergent2way
unique(acccnees_100kb_withcnees_narrow3Con$group)

## keep only sets of 4 cloades
acccnees_100kb_withcnees0_narrow3Con_sel = acccnees_100kb_withcnees0_narrow3Con %>%
  filter(group %in% c("swifts", "falcons", "lyrebirds", "passerides" )) %>% 
  dplyr::rename(clade = group)
  
unique(acccnees_100kb_withcnees0_narrow3Con_sel$clade)

acccnees_100kb_withcnees0_narrow3Con_selb = acccnees_100kb_withcnees0_narrow3Con_sel %>% 
  dplyr::select(clade, gene) %>% distinct()

```

num genes
```{r, fig.height=3, fig.width=4}

nonnectar_clade_order = c("swifts", "falcons", "lyrebirds", "passerides" )
nonnectar_clade_order_union = c("union", nonnectar_clade_order)
n_union = n_distinct(acccnees_100kb_withcnees0_narrow3Con_selb$gene) # 2251 <- union

p_narrow3Con = acccnees_100kb_withcnees0_narrow3Con_selb %>% 
  group_by(clade) %>% tally() %>%
  bind_rows(tibble(clade = "union", n = n_union)) %>% 
  ggplot(aes(x = fct_relevel(clade, nonnectar_clade_order_union), y = n)) +
  geom_col() + 
  geom_text(aes(label = n), vjust = 0, size = 2*2) +
  # facet_grid(.~bf) + 
  # scale_x_discrete(name = "logBFx >= n") +
  scale_y_continuous(expand = c(0,0,0.05,0), name = "gene count") + theme_m +
  ggtitle('Narrow (logBF2 > 3)') +
  theme(axis.title.x = element_blank()); p_narrow3Con

```

## 2. load GREAT - GO
### Nectar
#### Loose - only BP
```{r}

# focus on biological process
all = list.files(paste0(getwd(), "/great_BinomialP_go_v7/"), ".tsv", full.names = T)
all2 = all[grepl("biological_process", all)]
all2 = all2[grepl("Loose", all2)]; all2

out_go = lapply(all2, function(path){
  # path = all[1]
  x <- read_tsv(path, col_names = c('greatset', 'acc_criteria', 'accset', 'n_cnees', 'ont', 'go_id', 'n_cnees_anno', 'pval'), show_col_types = FALSE) 
  return(x)
}) %>% bind_rows()
# write_tsv(out_go, paste0("great_go_output_", Sys.Date(), ".tsv"))

unique(out_go$acc_criteria)
unique(out_go$accset)
out_go2 = out_go %>% 
  # keep only universe having more than >=40 genes # <-------
  filter(go_id %in% go_annoC_filtered$go_id) %>% 
  mutate(accset = gsub("2wayconvergent", "congvergent2way", accset),
         accset = gsub("3wayconvergent", "congvergent3way", accset),
         accset = gsub("3wayconvergent", "congvergent3way", accset),
         accset = gsub("genelv_", "genelv", accset),
         accset = gsub("4sets", "union", accset),
         accset = gsub("sunbirds_flowerpecker", "sunbirds", accset)) %>% 
  # FDR
  group_by(greatset, acc_criteria, accset, ont) %>% 
  mutate(padj = p.adjust(pval, method = 'fdr')) %>% 
  # look only basalPlusExtension
  filter(greatset == 'basalPlusExtension_proteincoding')
unique(out_go2$accset)
unique(out_go2$greatset)

x = out_go2 %>% group_by(greatset, acc_criteria, accset, ont) %>% 
  tally(); x # should all 17898 (go pathways); BP: 11763/filtered: 417

# FDR
go_sig_padj = out_go2 %>% 
  filter(padj < 0.05) %>% left_join(go_annoC)
print(n_distinct(go_sig_padj$go_id)) # 2929/filtered:195
print(unique(go_sig_padj$accset)) 

go_sig_padj_path = go_sig_padj %>% dplyr::select(-gene) %>% distinct() 

go_sig_padj_path_summary = go_sig_padj_path %>% group_by(greatset, acc_criteria, accset, ont) %>% 
  summarise(n = n_distinct(go_id))
n_distinct(go_sig_padj_path$goTerm) # 2929/filtered:195

# x = go_sig_padj_path %>% filter(accset == "sunbirds")
```

### Control
#### ControlLoose - only BP
```{r}

# focus on biological process
all = list.files(paste0(control_path, "/great_BinomialP_go_v7/"), ".tsv", full.names = T)
all2 = all[grepl("biological_process", all)]
all2 = all2[grepl("ControlLoose", all2)]; all2

out_go_con = lapply(all2, function(path){
  # path = all2[1]
  x <- read_tsv(path, col_names = c('greatset', 'acc_criteria', 'accset', 'n_cnees', 'ont', 'go_id', 'n_cnees_anno', 'pval'), show_col_types = FALSE) 
  return(x)
}) %>% bind_rows()
# write_tsv(out_go_con, "great_go_output.tsv")

unique(out_go_con$accset)
out_go_con2 = out_go_con %>% 
  # keep only universe having more than >=40 genes # <-------
  filter(go_id %in% go_annoC_filtered$go_id) %>% 
  mutate(accset = gsub("2wayconvergent", "congvergent2way", accset),
         accset = gsub("3wayconvergent", "congvergent3way", accset),
         accset = gsub("4wayconvergent", "congvergent4way", accset),
         accset = gsub("genelv_", "genelv", accset),
         accset = gsub("4sets", "union", accset),
         accset = gsub("sunbirds_flowerpecker", "sunbirds", accset)) %>% 
  # FDR
  group_by(greatset, acc_criteria, accset, ont) %>% 
  mutate(padj = p.adjust(pval, method = 'fdr')) %>% 
  # look only basalPlusExtension
  filter(greatset == 'basalPlusExtension_proteincoding')

unique(out_go_con2$accset)
unique(out_go_con2$greatset)

x = out_go_con2 %>% group_by(greatset, acc_criteria, accset, ont) %>% 
  tally(); x # should all 17898 (go pathways): 11763 BP/417

go_sig_padj_con = out_go_con2 %>% filter(padj < 0.05) %>% left_join(go_annoC)
print(n_distinct(go_sig_padj_con$go_id)) # 148
print(unique(go_sig_padj_con$accset)) #

go_sig_padj_con_path = go_sig_padj_con %>% dplyr::select(-gene) %>% distinct() 

go_sig_padj_con_path_summary = go_sig_padj_con_path %>% group_by(greatset, acc_criteria, accset, ont) %>% 
  summarise(n = n_distinct(go_id))
n_distinct(go_sig_padj_con_path$goTerm) # 148

```

# 3. hypergeometric on cnee, GO
Simple Enrichment Test -- calculate hypergeometric p-values in R
http://mengnote.blogspot.com/2012/12/calculate-correct-hypergeometric-p.html
How to use phyper in R
https://seqqc.wordpress.com/2019/07/25/how-to-use-phyper-in-r/

## function
```{r}
tmp_ont = "biological_process"
go_term_path = go_annoC %>% filter(ont == tmp_ont) %>% 
  # keep only universe having more than >=40 genes # <-------
  filter(go_id %in% go_annoC_filtered$go_id) %>% 
  dplyr::select(-gene) %>% distinct()
go_term_total = go_term_path %>% pull(go_id) %>% unique()
n_distinct(go_term_total) # 11876/filtered 662/417

hypergeometricFun = function(term, accset, acc_criteria = "Loose"){
  # accset = "union"
  # term = "GO_0006397"
   # acc_criteria = "Loose"
  
  # for each term, get gene list from our custom annotation
  go_tmp = go_annoC %>% filter(go_id  == term) 
  
  # input (nectar acc) cnees and their great gene assignment
  if(acc_criteria == "Loose"){
    acc_set_df = acccnees_100kb_withcnees0_loose%>% filter(group == accset)
  }else if(acc_criteria == "NarrowBF2_gt2"){
    acc_set_df = acccnees_100kb_withcnees0_narrow2 %>% filter(group == accset)
  } else if(acc_criteria == "NarrowBF2_gt3"){
    acc_set_df = acccnees_100kb_withcnees0_narrow3 %>% filter(group == accset)
  }else if(acc_criteria == "ControlLoose"){
    acc_set_df = acccnees_100kb_withcnees0_looseCon %>% filter(group == accset)
  }else if(acc_criteria == "ControlNarrowBF2_gt2"){
    acc_set_df = acccnees_100kb_withcnees0_narrow2Con %>% filter(group == accset)
  } else if(acc_criteria == "ControlNarrowBF2_gt3"){
    acc_set_df = acccnees_100kb_withcnees0_narrow3Con %>% filter(group == accset)}
  
  # gene associated with cnees (all), split to in term and not in term
  interm = allcnee_great %>% filter(gene %in% go_tmp$gene)
  # notinterm = allcnee_great %>% filter(! gene %in% go_tmp$gene)
  
  # for in term, split cnees to acc or not
  interm_acc = interm %>% filter(id %in% acc_set_df$id)
  interm_notacc = interm %>% filter(! id %in% acc_set_df$id)
  
  # for not in term, split cnees to acc or not
  # notinterm_acc = notinterm %>% filter(id %in% acc_set_df$id)
  # notinterm_notacc = notinterm %>% filter(! id %in% acc_set_df$id)
  
  # q: (number of input (nectar accelerated) cnees associated with the term of interest) - 1
  n_input = n_distinct(interm_acc$id)
  q = n_input-1 
  
  # m: the number of cnees associated with the term of interest
  m = n_distinct(interm_acc$id) + n_distinct(interm_notacc$id)
  
  # n: total number of cnees - number of cnees associated with the term of interest
  allcnee_great_notinterm = allcnee_great %>% filter(!gene %in% interm$gene)
  n = n_distinct(allcnee_great_notinterm$id)
  
  # k: number of input (nectar accelerated) cnees 
  k = n_distinct(acc_set_df$id)

  # Test for over-representation (enrichment)
  # phyper(hitInSample-1, hitInBackgroun, failInBackground, sampleSize, lower.tail= FALSE);
  hyper = phyper(q-1, m, n, k, lower.tail= FALSE);
  out_df = tibble(go_id = term, accset = accset,
                  q=q, m=m, n=n, k=k, pval = hyper)
  return(out_df)
}

```

### Nectar
#### Loose
##### proc. all sets 
```{r}
unique(go_sig_padj_path$accset)
# "Loose", "NarrowBF2_gt2", "NarrowBF2_gt3"
# "ControlLoose", "ControlNarrowBF2_gt2", "ControlNarrowBF2_gt3"

nectar_clade_order = c("hummingbirds", "parrots", "honeyeaters", "sunbirds")
nectar_clade_order_union = c("congvergent_genelvgteq2way", "congvergent_genelv3way", "congvergent_genelv4way",
                             "congvergent_gteq2way", "congvergent_gteq3way", "congvergent4way", "union", nectar_clade_order)

tmp_sets = nectar_clade_order_union
out_hyper_go_loose = parallel::mcmapply(FUN = hypergeometricFun, mc.cores = 16,
                                        term = rep(go_term_total, length(tmp_sets)),
                                        acc_criteria = "Loose",
                                        accset = rep(tmp_sets, each = length(go_term_total)), 
                                        SIMPLIFY = F)

out_hyper_go_loose_df = out_hyper_go_loose %>% bind_rows() %>% 
  group_by(accset) %>% 
  mutate(padj_h = p.adjust(pval, method = 'fdr')) %>% 
  left_join(go_term_path, by = c('go_id'))

table(out_hyper_go_loose_df$accset)

path = paste0(out_dir, "GO_", "Loose", "_hypogeometric_output_", Sys.Date(),".csv")
# write_csv(out_hyper_go_loose_df, file = path)

```

##### Great and hypogeometric overlap
```{r}

nectar_clade_order = c("hummingbirds", "parrots", "honeyeaters", "sunbirds")
nectar_clade_order_union = c("congvergent_genelvgteq2way", "congvergent_genelv3way", "congvergent_genelv4way",
                             "congvergent_gteq2way", "congvergent_gteq3way", "congvergent4way", "union", nectar_clade_order)

# nectar
tmp_acc_criteria = "Loose"
tmp_p_cutoff = 0.05
if(tmp_p_cutoff == 0.05){
  fdr_flag = "FDR"
}else if(tmp_p_cutoff == 0.2){
  fdr_flag = "FDR2"
}

loose_hypo_marked = lapply(nectar_clade_order_union, function(accsetIN){
  # accsetIN = "union"
  print(accsetIN)
  great_kegg = out_go2 %>% 
    filter(greatset == "basalPlusExtension_proteincoding", 
           acc_criteria == tmp_acc_criteria, accset == accsetIN) %>% 
    left_join(go_term_path, by = c('go_id', 'ont')) %>% 
    filter(padj < tmp_p_cutoff)
  
  hypo = out_hyper_go_loose_df %>% 
    filter(accset == accsetIN) %>%
    filter(padj_h < tmp_p_cutoff)
  
  overlap = great_kegg %>% 
    left_join(hypo, by = c("go_id", "goTerm", "accset", "ont"), suffix = c("_g", "_h")) %>% 
    mutate(sig = ifelse(padj_h< 0.05 & padj<0.05, '*', NA)) %>%
    dplyr::rename(clade = accset) %>%
    mutate(log_p = -log10(padj)) 
  # mutate(go_id = gsub("_", ":", go_id)) 
  if(nrow(overlap) > 0){return(overlap)}
}) %>% bind_rows()


loose_hypo_marked %>% 
  filter(!is.na(sig)) %>% 
  group_by(clade) %>% 
  tally()
#   clade                    n
#   <chr>                <int>
# 1 congvergent_gteq2way    25
# 2 congvergent_gteq3way    10
# 3 honeyeaters             38
# 4 hummingbirds            34
# 5 parrots                 19
# 6 sunbirds                27
# 7 union                   35
unique(loose_hypo_marked$clade)


# look up gene for sig
x = loose_hypo_marked %>% 
  filter(!is.na(sig)) %>% 
  left_join(go_annoCm)
y = x %>% filter(gene %in% c("SI"))

z = go_annoCm %>% filter(gene %in% c("SI")) # eqgt2 and honeyeater
z = go_annoCm %>% filter(grepl("AMY", gene)) # eqgt2, union, hummingbirds, parrots
zz = loose_hypo_marked %>% 
  filter(!is.na(sig)) %>% 
  mutate(go_id2 = gsub("_", ":", go_id)) %>% 
  filter(go_id2 %in% z$go_id)


# nectar >= 2 clades
loose_hypo_onlyoverlap_gteq2 = loose_hypo_marked %>% 
  filter(clade %in% nectar_clade_order) %>% 
  group_by(go_id) %>% 
  mutate(n_clades = n_distinct(clade)) %>% 
  filter(n_clades >= 2) %>% 
  filter(sig == "*")
n_distinct(loose_hypo_onlyoverlap_gteq2$go_id) # 55

```

### Control
#### ControlLoose
##### proc. all sets 
```{r}
unique(go_sig_padj_con_path$accset)
# "Loose", "NarrowBF2_gt2", "NarrowBF2_gt3"
# "ControlLoose", "ControlNarrowBF2_gt2", "ControlNarrowBF2_gt3"

nonnectar_clade_order = c("swifts", "falcons", "lyrebirds", "passerides" )
nonnectar_clade_order_union = c("congvergent_genelvgteq2way", "congvergent_genelv3way", "congvergent_genelv4way",
                             "congvergent_gteq2way", "congvergent_gteq3way", "congvergent4way", "union", nonnectar_clade_order)

tmp_sets = nonnectar_clade_order_union
out_hyper_go_looseCon = parallel::mcmapply(FUN = hypergeometricFun, mc.cores = 16,
                                        term = rep(go_term_total, length(tmp_sets)),
                                        acc_criteria = "ControlLoose",
                                        accset = rep(tmp_sets, each = length(go_term_total)), 
                                        SIMPLIFY = F)

out_hyper_go_looseCon_df = out_hyper_go_looseCon %>% bind_rows() %>% 
  group_by(accset) %>% 
  mutate(padj_h = p.adjust(pval, method = 'fdr')) %>% 
  left_join(go_term_path, by = c('go_id'))

table(out_hyper_go_looseCon_df$accset)

path = paste0(out_dir, "GO_", "ControlLoose", "_hypogeometric_output_", Sys.Date(),".csv")
# write_csv(out_hyper_go_looseCon_df, file = path)
```

##### Great and hypogeometric overlap
```{r}

nonnectar_clade_order = c("swifts", "falcons", "lyrebirds", "passerides" )
nonnectar_clade_order_union = c("congvergent_genelvgteq2way", "congvergent_genelv3way", "congvergent_genelv4way",
                             "congvergent_gteq2way", "congvergent_gteq3way", "congvergent4way", "union", nonnectar_clade_order)

# nonnectar
tmp_acc_criteria = "ControlLoose"
tmp_p_cutoff = 0.05
if(tmp_p_cutoff == 0.05){
  fdr_flag = "FDR"
}else if(tmp_p_cutoff == 0.2){
  fdr_flag = "FDR2"
}

conloose_hypo_marked = lapply(nonnectar_clade_order_union, function(accsetIN){
  # accsetIN = "union"
  great_kegg = out_go_con2 %>% 
    filter(greatset == "basalPlusExtension_proteincoding", 
           acc_criteria == tmp_acc_criteria, accset == accsetIN) %>% 
    left_join(go_term_path, by = c('go_id', 'ont')) %>% 
    filter(padj < tmp_p_cutoff)
  
  hypo = out_hyper_go_looseCon_df %>% 
    filter(accset == accsetIN) %>%
    filter(padj_h < tmp_p_cutoff)
  
  overlap = great_kegg %>% 
    left_join(hypo, by = c("go_id", "goTerm", "accset", "ont"), suffix = c("_g", "_h")) %>% 
    mutate(sig = ifelse(padj_h< 0.05 & padj<0.05, '*', NA)) %>%
    dplyr::rename(clade = accset) %>%
    mutate(log_p = -log10(padj)) 
  # mutate(go_id = gsub("_", ":", go_id)) 
  if(nrow(overlap) > 0){return(overlap)}
}) %>% bind_rows()

conloose_hypo_marked %>% 
  filter(!is.na(sig)) %>% 
  group_by(clade) %>% 
  tally()
#   clade                    n
#   <chr>                <int>
# 1 congvergent_gteq2way     8
# 2 falcons                 23
# 3 lyrebirds               34
# 4 passerides              11
# 5 swifts                  19
# 6 union                   32
unique(conloose_hypo_marked$clade)

# control >= 2 clades
conloose_hypo_onlyoverlap_gteq2 = conloose_hypo_marked %>% 
  filter(clade %in% nonnectar_clade_order) %>% 
  group_by(go_id) %>% 
  mutate(n_clades = n_distinct(clade)) %>% 
  filter(n_clades >= 2) %>% 
  filter(sig == "*")
n_distinct(conloose_hypo_onlyoverlap_gteq2$go_id) # 38
```

# 4. GO 
## plot func
```{r}
# Object with ancestor GO terms
GO_anc = as.list(GOBPANCESTOR)
GO_semsim = godata("org.Hs.eg.db", ont="BP")
GO_def = suppressMessages(AnnotationDbi::select(GO.db,
                                                keys=(keys(GO.db)),
                                                columns=c("GOID","TERM","DEFINITION"),
                                                keytype="GOID"))

plotFunc_path_size_go = function(input_path_df, input_acc_criteria){
  # input_accset, nectar_only
  # input_path_df = nectar_only
  # input_acc_criteria = tmp_acc_criteria
  
  phyloaccgo_union = input_path_df %>% 
    mutate(go_id = gsub("_", ":", go_id)) %>% 
    # dplyr::rename(clade = accset) %>% 
    mutate(rank = n_distinct(clade)) %>% 
    mutate(log_p = -log10(pval_g)) %>% 
    dplyr::select(clade, go_id, goTerm, log_p, rank)
  
  go_annoCm = go_annoC %>% 
    mutate(go_id = gsub("_", ":", go_id)) %>% 
    dplyr::select(-ont, -goTerm) %>% 
    distinct()
  
  # input (nectar acc) cnees and their great gene assignment
  if(input_acc_criteria == "Loose"){
    acccnees_to_path = acccnees_100kb_withcnees0_loose_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_id))
  }else if(input_acc_criteria == "NarrowBF2_gt2"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow2_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_id))
  } else if(input_acc_criteria == "NarrowBF2_gt3"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow3_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_id))
  }else if(input_acc_criteria == "ControlLoose"){
    acccnees_to_path = acccnees_100kb_withcnees0_looseCon_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_id))
  } else if(input_acc_criteria == "ControlNarrowBF2_gt2"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow2Con_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_id))
  } else if(input_acc_criteria == "ControlNarrowBF2_gt3"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow3Con_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_id))
  }

  phyloaccgo_with_gene = phyloaccgo_union %>%
    left_join(acccnees_to_path, by = c("go_id"))  %>% 
    dplyr::select(-clade.x) %>% 
    dplyr::rename(clade = clade.y) 
  if(grepl("control", input_acc_criteria, ignore.case = TRUE)){
    phyloaccgo_with_gene$clade =  factor(phyloaccgo_with_gene$clade, levels = nonnectar_clade_order)
  }else{ phyloaccgo_with_gene$clade =  factor(phyloaccgo_with_gene$clade, levels = nectar_clade_order) }
  
  
  # v2: num cnee per term per clade
  geneCount = phyloaccgo_with_gene %>% 
    group_by(go_id, clade) %>% # per term per clade, how many (unique) cnees, (sum of all genes)
    mutate(n_genes_perclade_perterm = n_distinct(gene)) %>% 
    group_by(go_id) %>% 
    mutate(n_clades = n_distinct(clade),
           sum_gene = sum(n_genes_perclade_perterm)) 
  if(grepl("control", input_acc_criteria, ignore.case = TRUE)){
    geneCount$clade =  factor(geneCount$clade, levels = nonnectar_clade_order)
  }else{ geneCount$clade =  factor(geneCount$clade, levels = nectar_clade_order) }
  
  geneCount_b = geneCount %>% 
    dplyr::select(-gene) %>% distinct() %>% 
    group_by(go_id) %>% 
    mutate(n_clades = length(unique(clade)),
           sum_gene = sum(n_genes_perclade_perterm)) 
  dim(geneCount_b) # 2660   13
  
  ## color of dots in grey [final] 
  # 2.2.1 sort by n_clades, sum_gene
  y = geneCount_b %>% arrange(n_clades, sum_gene)
  y_lab = unique(y$goTerm)
  y$goTerm = factor(y$goTerm, y_lab)
  print(n_distinct(y$goTerm))
  
  size_max = 3
  colp = brewer.pal(4, 'Dark2')
  
  p_term34 = y %>% ggplot() +
    geom_point(aes(y = goTerm,
                   x = clade, size = n_genes_perclade_perterm), color = 'grey50') +
    scale_color_manual(values = colp, guide = "none") +
    scale_size_binned(name = "Number of genes", range = c(0.2, size_max), n.breaks = 4) +
    theme_m +
    theme_a; p_term34
  
  pal = brewer.pal(9, 'Reds')
  p3 = ggplot(y ) +
    geom_tile(aes(x = 1, 
                  y = goTerm,
                  fill = log_p), color = 'white') +
    scale_x_continuous(expand = c(0,0,0.05,0), breaks = 1, labels = expression(-~log[10]~P)) +
    scale_y_discrete(expand = c(0,0,0,0)) +
    scale_fill_gradient(low = pal[2], high = "#dc2943ff", name = expression(-~log[10]~P), n.breaks = 4) +
    theme_m +
    theme_a; p3
  
  p = cowplot::plot_grid(p3, p_term34, ncol= 2, scale = c(0.95, 1), align = 'v');
}

plotFunc_path_size_only_go = function(input_path_df, input_acc_criteria){
  # input_accset, nectar_only
  # input_path_df = nectar_only
  # input_acc_criteria = tmp_acc_criteria
  
  phyloaccgo_union = input_path_df %>% 
    mutate(go_id = gsub("_", ":", go_id)) %>% 
    # dplyr::rename(clade = accset) %>% 
    mutate(rank = n_distinct(clade)) %>% 
    mutate(log_p = -log10(pval_g)) %>% 
    dplyr::select(clade, go_id, goTerm, log_p, rank)
  
  go_annoCm = go_annoC %>% 
    mutate(go_id = gsub("_", ":", go_id)) %>% 
    dplyr::select(-ont, -goTerm) %>% 
    distinct()
  
  # input (nectar acc) cnees and their great gene assignment
  acccnees_to_path = get_cneegene_4clades(input_acc_criteria) %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_id))
 
  phyloaccgo_with_gene = phyloaccgo_union %>%
    left_join(acccnees_to_path, by = c("go_id"))  %>% 
    dplyr::select(-clade.x) %>% 
    dplyr::rename(clade = clade.y) 
  phyloaccgo_with_gene$clade =  factor(phyloaccgo_with_gene$clade, levels = nectar_clade_order)
  
  # v2: num cnee per term per clade
  geneCount = phyloaccgo_with_gene %>% 
    group_by(go_id, clade) %>% # per term per clade, how many (unique) cnees, (sum of all genes)
    mutate(n_genes_perclade_perterm = n_distinct(gene)) %>% 
    group_by(go_id) %>% 
    mutate(n_clades = n_distinct(clade),
           sum_gene = sum(n_genes_perclade_perterm)) 
  geneCount$clade <- factor(geneCount$clade, levels = nectar_clade_order)
  
  geneCount_b = geneCount %>% 
    dplyr::select(-gene) %>% distinct() %>% 
    group_by(go_id) %>% 
    mutate(n_clades = length(unique(clade)),
           sum_gene = sum(n_genes_perclade_perterm)) 
  dim(geneCount_b) # 2660   13
  
  ## color of dots in grey [final] 
  # 2.2.1 sort by n_clades, sum_gene
  y = geneCount_b #%>% arrange(n_clades, sum_gene)
  # y_lab = unique(y$goTerm)
  # y$goTerm = factor(y$goTerm, y_lab)
  print(n_distinct(y$goTerm))
  
  size_max = 3
  colp = brewer.pal(4, 'Dark2')
  
  p_term34 = y %>% ggplot() +
    geom_point(aes(y = goTerm,
                   x = clade, size = n_genes_perclade_perterm), color = 'grey50') +
    scale_color_manual(values = colp, guide = "none") +
    scale_size_binned(name = "Number of genes", range = c(0.2, size_max), n.breaks = 4) +
    theme_m +
    theme_a; p_term34
}

plotFunc_path_size_go_noimmediatechildren = function(input_path_df, input_acc_criteria){
  # input_accset, input_padj
  # input_path_df = nectar_only  
  # input_acc_criteria = tmp_acc_criteria
  
  ## remove immediate children
  # library(GOfuncR)
  go_id = gsub("_", ":", input_path_df$go_id)
  child_nodes = GOfuncR::get_child_nodes(go_id)
  child_nodes = child_nodes %>% filter(distance == 1) # noimmediatechildren
  
  l = list('input' = go_id, 'children' = child_nodes$child_go_id)
  # ggvenn::ggvenn(l) # 43:17:2432
  v = gplots::venn(l, show.plot = F)
  isect <- attr(v, "intersection")
  # cat(isect$`input:children`, sep = "\n") # 17
  redund = isect$`input:children`
  redund2 = gsub(":", "_", redund)
  input_path_df_rm = input_path_df %>% filter(!go_id %in% redund2)
  print(n_distinct(input_path_df_rm$go_id))
  
  phyloaccgo_union = input_path_df_rm %>% 
    mutate(go_id = gsub("_", ":", go_id)) %>% 
    # dplyr::rename(clade = accset) %>% 
    mutate(rank = n_distinct(clade)) %>% 
    mutate(log_p = -log10(pval_g)) %>% 
    dplyr::select(clade, go_id, goTerm, log_p, rank)
  
  go_annoCm = go_annoC %>% 
    mutate(go_id = gsub("_", ":", go_id)) %>% 
    dplyr::select(-ont, -goTerm) %>% 
    distinct()
  
  # input (nectar acc) cnees and their great gene assignment
  if(input_acc_criteria == "Loose"){
    acccnees_to_path = acccnees_100kb_withcnees0_loose_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_id))
  }else if(input_acc_criteria == "NarrowBF2_gt2"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow2_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_id))
  } else if(input_acc_criteria == "NarrowBF2_gt3"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow3_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_id))
  }else if(input_acc_criteria == "ControlLoose"){
    acccnees_to_path = acccnees_100kb_withcnees0_looseCon_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_annoCm))
  } else if(input_acc_criteria == "ControlNarrowBF2_gt2"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow2Con_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_annoCm))
  } else if(input_acc_criteria == "ControlNarrowBF2_gt3"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow3Con_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_annoCm))
  }

  phyloaccgo_with_gene = phyloaccgo_union %>%
    left_join(acccnees_to_path, by = c("go_id"))  %>% 
    dplyr::select(-clade.x) %>% 
    dplyr::rename(clade = clade.y) 
  phyloaccgo_with_gene$clade =  factor(phyloaccgo_with_gene$clade, levels = nectar_clade_order)
  
  # v2: num cnee per term per clade
  geneCount = phyloaccgo_with_gene %>% 
    group_by(go_id, clade) %>% # per term per clade, how many (unique) cnees, (sum of all genes)
    mutate(n_genes_perclade_perterm = n_distinct(gene)) %>% 
    group_by(go_id) %>% 
    mutate(n_clades = n_distinct(clade),
           sum_gene = sum(n_genes_perclade_perterm)) 
  geneCount$clade <- factor(geneCount$clade, levels = nectar_clade_order)
  
  geneCount_b = geneCount %>% 
    dplyr::select(-gene) %>% distinct() %>% 
    group_by(go_id) %>% 
    mutate(n_clades = length(unique(clade)),
           sum_gene = sum(n_genes_perclade_perterm)) 
  dim(geneCount_b) # 2660   13
  
  ## color of dots in grey [final] 
  # 2.2.1 sort by n_clades, sum_gene
  y = geneCount_b %>% arrange(n_clades, sum_gene)
  y_lab = unique(y$goTerm)
  y$goTerm = factor(y$goTerm, y_lab)
  print(n_distinct(y$goTerm))
  
  size_max = 3
  colp = brewer.pal(4, 'Dark2')
  
  p_term34 = y %>% ggplot() +
    geom_point(aes(y = goTerm,
                   x = clade, size = n_genes_perclade_perterm), color = 'grey50') +
    scale_color_manual(values = colp, guide = "none") +
    scale_size_binned(name = "Number of genes", range = c(0.2, size_max), n.breaks = 4) +
    theme_m +
    theme_a; p_term34
  
  pal = brewer.pal(9, 'Reds')
  p3 = ggplot(y ) +
    geom_tile(aes(x = 1, 
                  y = goTerm,
                  fill = log_p), color = 'white') +
    scale_x_continuous(expand = c(0,0,0.05,0), breaks = 1, labels = expression(-~log[10]~P)) +
    scale_y_discrete(expand = c(0,0,0,0)) +
    scale_fill_gradient(low = pal[2], high = "#dc2943ff", name = expression(-~log[10]~P), n.breaks = 4) +
    theme_m +
    theme_a; # p3
  
  p = cowplot::plot_grid(p3, p_term34, ncol= 2, scale = c(0.92, 1), align = 'v');
}

plotFunc_path_size_go_nochildren = function(input_path_df, input_acc_criteria){
  # input_accset, input_padj
  # input_path_df = nectar_only  
  # input_acc_criteria = tmp_acc_criteria
  
  ## remove immediate children
  # library(GOfuncR)
  go_id = gsub("_", ":", input_path_df$go_id)
  child_nodes = GOfuncR::get_child_nodes(go_id)
  child_nodes = child_nodes %>% filter(distance >= 1)
  
  l = list('input' = go_id, 'children' = child_nodes$child_go_id)
  # ggvenn::ggvenn(l) # 43:17:2432
  v = gplots::venn(l, show.plot = F)
  isect <- attr(v, "intersection")
  # cat(isect$`input:children`, sep = "\n") # 17
  redund = isect$`input:children`
  redund2 = gsub(":", "_", redund)
  input_path_df_rm = input_path_df %>% filter(!go_id %in% redund2)
  print(n_distinct(input_path_df_rm$go_id))
  
  phyloaccgo_union = input_path_df_rm %>% 
    mutate(go_id = gsub("_", ":", go_id)) %>% 
    # dplyr::rename(clade = accset) %>% 
    mutate(rank = n_distinct(clade)) %>% 
    mutate(log_p = -log10(pval_g)) %>% 
    dplyr::select(clade, go_id, goTerm, log_p, rank)
  
  go_annoCm = go_annoC %>% 
    mutate(go_id = gsub("_", ":", go_id)) %>% 
    dplyr::select(-ont, -goTerm) %>% 
    distinct()
  
  # input (nectar acc) cnees and their great gene assignment
  if(input_acc_criteria == "Loose"){
    acccnees_to_path = acccnees_100kb_withcnees0_loose_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_id))
  }else if(input_acc_criteria == "NarrowBF2_gt2"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow2_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_id))
  } else if(input_acc_criteria == "NarrowBF2_gt3"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow3_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_id))
  }else if(input_acc_criteria == "ControlLoose"){
    acccnees_to_path = acccnees_100kb_withcnees0_looseCon_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_annoCm))
  } else if(input_acc_criteria == "ControlNarrowBF2_gt2"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow2Con_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_annoCm))
  } else if(input_acc_criteria == "ControlNarrowBF2_gt3"){
    acccnees_to_path = acccnees_100kb_withcnees0_narrow3Con_sel %>% 
      left_join(go_annoCm) %>%  # but not all go is enriched
      filter(!is.na(go_annoCm))
  }

  phyloaccgo_with_gene = phyloaccgo_union %>%
    left_join(acccnees_to_path, by = c("go_id"))  %>% 
    dplyr::select(-clade.x) %>% 
    dplyr::rename(clade = clade.y) 
  phyloaccgo_with_gene$clade =  factor(phyloaccgo_with_gene$clade, levels = nectar_clade_order)
  
  # v2: num cnee per term per clade
  geneCount = phyloaccgo_with_gene %>% 
    group_by(go_id, clade) %>% # per term per clade, how many (unique) cnees, (sum of all genes)
    mutate(n_genes_perclade_perterm = n_distinct(gene)) %>% 
    group_by(go_id) %>% 
    mutate(n_clades = n_distinct(clade),
           sum_gene = sum(n_genes_perclade_perterm)) 
  geneCount$clade <- factor(geneCount$clade, levels = nectar_clade_order)
  
  geneCount_b = geneCount %>% 
    dplyr::select(-gene) %>% distinct() %>% 
    group_by(go_id) %>% 
    mutate(n_clades = length(unique(clade)),
           sum_gene = sum(n_genes_perclade_perterm)) 
  dim(geneCount_b) # 2660   13
  
  ## color of dots in grey [final] 
  # 2.2.1 sort by n_clades, sum_gene
  y = geneCount_b %>% arrange(n_clades, sum_gene)
  y_lab = unique(y$goTerm)
  y$goTerm = factor(y$goTerm, y_lab)
  print(n_distinct(y$goTerm))
  
  size_max = 3
  colp = brewer.pal(4, 'Dark2')
  
  p_term34 = y %>% ggplot() +
    geom_point(aes(y = goTerm,
                   x = clade, size = n_genes_perclade_perterm), color = 'grey50') +
    scale_color_manual(values = colp, guide = "none") +
    scale_size_binned(name = "Number of genes", range = c(0.2, size_max), n.breaks = 4) +
    theme_m +
    theme_a; p_term34
  
  pal = brewer.pal(9, 'Reds')
  p3 = ggplot(y ) +
    geom_tile(aes(x = 1, 
                  y = goTerm,
                  fill = log_p), color = 'white') +
    scale_x_continuous(expand = c(0,0,0.05,0), breaks = 1, labels = expression(-~log[10]~P)) +
    scale_y_discrete(expand = c(0,0,0,0)) +
    scale_fill_gradient(low = pal[2], high = "#dc2943ff", name = expression(-~log[10]~P), n.breaks = 4) +
    theme_m +
    theme_a; # p3
  
  p = cowplot::plot_grid(p3, p_term34, ncol= 2, scale = c(0.92, 1), align = 'v');
}

plotFunc_path_size_go_repres_N = function(input_path_df, input_acc_criteria, N){
  # input_accset, input_padj
  # input_path_df = nectar_only  
  # input_acc_criteria = tmp_acc_criteria
  
  input_path_df = input_path_df %>% 
    mutate(go_id2 = gsub("_", ":", go_id)) # normal format
  go_id = input_path_df$go_id2
  
  ## cluster go
  mat_all <- GO_similarity(go_id, ont = "BP", db = 'org.Hs.eg.db')
  go_df <- simplifyGO(mat_all, plot = FALSE) 
  
  ### Retrieve representative GO term for each cluster
  repr_GO = 
    # Retrieve ancestral GO terms for each GO term in go_id
    GO_anc[go_id] %>% stack() %>% `colnames<-`(c("ancestral", "go_id")) %>% 
    # Add clusters from simplifyGO and count the number of times each ancestral GO appears in ancestral terms for each GO cluster
    left_join(dplyr::select(go_df, c("cluster", "id")), by = setNames("id", "go_id")) %>% 
    group_by(cluster, ancestral) %>% add_count() %>% ungroup %>% 
    # Add Information Content for each ancestral GO and calculate "importance" (most informative somewhat common ancestral GO term)
    mutate(IC = GO_semsim@IC[ancestral]) %>% 
    mutate(importance = (n*IC^2)) %>% 
    group_by(cluster) %>% 
    # dplyr::slice(which.max(importance)) %>% 
    dplyr::slice_max(order_by = importance, n = N) %>% 
    # Clean output
    left_join(dplyr::select(GO_def, c("GOID","TERM")), by = setNames("GOID", "ancestral")) %>% 
    dplyr::select(c("ancestral","cluster","importance","TERM"))

  # Function to find matching elements
  find_ids <- function(n, df) {
    col_values <- df$id[df$id %in% df$id[df$cluster == n]]
    # return(paste(elements, collapse = ","))
    return(col_values)
  }
  
  find_pvalues <- function(n, df) {
    col_values <- df$padj[df$go_id2 %in% unlist(repr_GO$gos[repr_GO$cluster == n])]
    # return(paste(elements, collapse = ","))
    return(col_values)
  }

  # Add new columns with all p-values and all GOs 
  repr_GO$gos <- sapply(repr_GO$cluster, find_ids, go_df)
  repr_GO$pvalues <- sapply(repr_GO$cluster, find_pvalues, input_path_df)
  repr_GO$minpval <- sapply(repr_GO$pvalues, min)
  
  # Concatenate each list of p-values and GOs into a comma-separated string
  repr_GO$pvalues <- sapply(repr_GO$pvalues, function(x) format(x, digits=4))
  repr_GO$pvalues <- sapply(repr_GO$pvalues, function(x) paste(x, collapse = ","))
  repr_GO$gos <- sapply(repr_GO$gos, function(x) paste(x, collapse = ","))
  
  phyloaccgo_union = repr_GO %>% 
    mutate(go_id = ancestral) %>% 
    mutate(log_p = -log10(minpval)) %>% 
    dplyr::select( go_id, TERM, log_p)
  
  phyloaccgo_with_gene = phyloaccgo_union 
  y = phyloaccgo_with_gene %>% arrange(log_p)
  y_lab = unique(y$TERM)
  y$TERM = factor(y$TERM, y_lab)
  print(n_distinct(y$TERM))
  
  pal = brewer.pal(9, 'Reds')
  p3 = ggplot(y ) +
    geom_tile(aes(x = 1, 
                  y = TERM,
                  fill = log_p), color = 'white') +
    scale_x_continuous(expand = c(0,0,0.05,0), breaks = 1, labels = expression(-~log[10]~P)) +
    scale_y_discrete(expand = c(0,0,0,0)) +
    scale_fill_gradient(low = pal[2], high = "#dc2943ff", name = expression(-~log[10]~P), n.breaks = 4) +
    theme_m +
    theme_a; # p3
  
  # p = cowplot::plot_grid(p3, p_term34, ncol= 2, scale = c(0.92, 1), align = 'v');
  # return(list(p, repr_GO))
  return(list(p3, repr_GO))
}

plotFunc_path_size_go_repres_Nchildren = function(input_path_df, input_acc_criteria, N_children){
  # input_accset, input_padj
  # input_path_df = nectar_only  
  # input_acc_criteria = tmp_acc_criteria
  
  input_path_df = input_path_df %>% 
    mutate(go_id2 = gsub("_", ":", go_id)) # normal format
  go_id = input_path_df$go_id2
  
  ## cluster go
  mat_all <- GO_similarity(go_id, ont = "BP", db = 'org.Hs.eg.db')
  go_df <- simplifyGO(mat_all, plot = FALSE) 
  
  ## adding gene counts to go_df -mk
  cnee_gene_tmp = get_cneegene_4clades(input_acc_criteria) %>% 
    dplyr::select(-id) %>% distinct()
  go_annoCm_gene_clade = go_annoCm %>% 
    filter(go_id %in% go_df$id) %>% 
    left_join(cnee_gene_tmp) %>% 
    filter(!is.na(clade)) %>% 
    group_by(go_id) %>% 
    summarise(n_genes = n_distinct(gene),
              n_clades = n_distinct(clade)) %>% 
    ungroup() %>% 
    mutate(n_genes_rescale = scales::rescale(n_genes, to = c(1,10)))
  go_df2 = go_df %>% left_join(go_annoCm_gene_clade, by = c("id" = "go_id"))
  
  ### Retrieve representative GO term for each cluster
  repr_GO = 
    # Retrieve ancestral GO terms for each GO term in go_id
    GO_anc[go_id] %>% stack() %>% `colnames<-`(c("ancestral", "go_id")) %>% 
    # rm 'all' -mk
    filter(ancestral != "all") %>% 
    # Add clusters from simplifyGO and count the number of times each ancestral GO appears in ancestral terms for each GO cluster
    left_join(dplyr::select(go_df2, c("cluster", "id", "n_genes", "n_genes_rescale", "n_clades")), by = setNames("id", "go_id")) %>%  # -mk: add n_genes
    group_by(cluster, ancestral) %>% add_count() %>% ungroup %>%  # n is the # of children for each ancestor
    # Add Information Content for each ancestral GO and calculate "importance" (most informative somewhat common ancestral GO term)
    mutate(IC = GO_semsim@IC[ancestral],
           IC_scale = scales::rescale(IC, to = c(1,10))) %>% 
    mutate(importance = (n*IC^2)) %>% 
    # Add Information Content for children as well -mk
    mutate(ICc = GO_semsim@IC[go_id],
           ICc_scale = scales::rescale(ICc, to = c(1,10))) %>% 
    mutate(importance_child = (n_genes_rescale*ICc_scale^2)) 
  
  repr_GO_anc = repr_GO %>% 
    dplyr::select(cluster, ancestral, n, IC, importance) %>% distinct() %>% 
    left_join(dplyr::select(GO_def, c("GOID","TERM")), by = c("ancestral" = "GOID")) %>% 
    # take 1 ancestor per cluster
    group_by(cluster) %>% 
    slice_max(order_by = importance, n = 1) 

  repr_GO_child = repr_GO %>% 
    dplyr::select(cluster, go_id, n_clades, n_genes, n_genes_rescale, ICc, ICc_scale, importance_child) %>% distinct() %>% 
    left_join(dplyr::select(GO_def, c("GOID","TERM")), by = c("go_id" = "GOID")) %>%  
    # remove terms overlaps with anc
    filter(!go_id %in% repr_GO_anc$ancestral) %>% 
    # take 2 children per cluster
    group_by(cluster) %>% 
    slice_max(order_by = importance_child, n = N_children, with_ties = FALSE) 
  
  repr_GO2 = repr_GO_anc %>% 
    full_join(repr_GO_child, by = "cluster", suffix = c("_anc", "_des")) %>% 
    dplyr::select(cluster, ancestral, TERM_anc, importance, go_id, TERM_des, importance_child) %>% 
    arrange(desc(importance), desc(importance_child))
  
  # Function to find matching elements
  find_ids <- function(n, df) {
    col_values <- df$id[df$id %in% df$id[df$cluster == n]]
    # return(paste(elements, collapse = ","))
    return(col_values) }
  
  find_pvalues <- function(n, df) {
    col_values <- df$padj[df$go_id2 %in% unlist(repr_GO2$gos[repr_GO2$cluster == n])]
    # return(paste(elements, collapse = ","))
    return(col_values)}
  
  find_pvalue_des <- function(goid, df) {
    col_values <- df$padj[df$go_id2 %in% goid ]
    # return(paste(elements, collapse = ","))
    return(col_values)}

  # Add new columns with all p-values and all GOs 
  repr_GO2$gos <- sapply(repr_GO2$cluster, find_ids, go_df)
  repr_GO2$pvalues <- sapply(repr_GO2$cluster, find_pvalues, input_path_df)
  repr_GO2$minpval <- sapply(repr_GO2$pvalues, min)
  repr_GO2$pvalue_desc <- sapply(repr_GO2$go_id, find_pvalue_des, input_path_df)
  
  # Concatenate each list of p-values and GOs into a comma-separated string
  repr_GO2$pvalues <- sapply(repr_GO2$pvalues, function(x) format(x, digits=4))
  repr_GO2$pvalues <- sapply(repr_GO2$pvalues, function(x) paste(x, collapse = ","))
  repr_GO2$gos <- sapply(repr_GO2$gos, function(x) paste(x, collapse = ","))
  
  repr_GO3_anc = repr_GO2 %>% 
    dplyr::select(-TERM_des, -importance_child, -importance, -go_id, -pvalue_desc) %>% distinct() %>% 
    dplyr::rename( TERM = TERM_anc, padj = minpval, go_id = ancestral) %>% 
    mutate(ori = "ancestral")
  
  repr_GO3_des = repr_GO2 %>% 
    dplyr::select(-TERM_anc, -ancestral, -importance, -importance_child, -gos, -pvalues, -minpval) %>% distinct() %>% 
    dplyr::rename( TERM = TERM_des, padj = pvalue_desc) %>% 
    mutate(ori = "descendent")
  repr_GO3 = repr_GO3_anc %>% bind_rows(repr_GO3_des) %>% 
    mutate(log_p = -log10(padj)) %>% 
    arrange(cluster, desc(ori))
  
  y = repr_GO3
  y_lab = unique(y$TERM)
  y$TERM = factor(y$TERM, y_lab)
  print(n_distinct(y$TERM))
  
  pal = brewer.pal(9, 'Reds')
  p3 = ggplot(y ) +
    geom_tile(aes(x = ori, 
                  y = TERM,
                  fill = log_p), color = 'black') +
    scale_x_discrete(expand = c(0,0,0.05,0)) +
    scale_y_discrete(expand = c(0,0,0,0)) +
    # facet_grid(.~ori, scales = "free", space = "free") +
    scale_fill_gradient(low = pal[2], high = "#dc2943ff", name = expression(-~log[10]~P), n.breaks = 4) +
    theme_m +
    theme_a; p3
  
  # p = cowplot::plot_grid(p3, p_term34, ncol= 2, scale = c(0.92, 1), align = 'v');
  # return(list(p, repr_GO))
  return(list(p3, repr_GO3))
}

plotFunc_path_size_go_repres_Nchildren_byp = function(input_path_df, input_acc_criteria, N_children){
  # input_accset, input_padj
  # input_path_df = nectar_only  
  # input_acc_criteria = tmp_acc_criteria
  
  input_path_df = input_path_df %>% 
    mutate(go_id2 = gsub("_", ":", go_id)) # normal format
  go_id = input_path_df$go_id2
  
  ## cluster go
  mat_all <- GO_similarity(go_id, ont = "BP", db = 'org.Hs.eg.db')
  go_df <- simplifyGO(mat_all, plot = FALSE) 
  
  ## adding gene counts to go_df -mk
  cnee_gene_tmp = get_cneegene_4clades(input_acc_criteria) %>% 
    dplyr::select(-id) %>% distinct()
  go_annoCm_gene_clade = go_annoCm %>% 
    filter(go_id %in% go_df$id) %>% 
    left_join(cnee_gene_tmp) %>% 
    filter(!is.na(clade)) %>% 
    group_by(go_id) %>% 
    summarise(n_genes = n_distinct(gene),
              n_clades = n_distinct(clade)) %>% 
    ungroup() %>% 
    mutate(n_genes_rescale = scales::rescale(n_genes, to = c(1,10)))
  go_df2 = go_df %>% left_join(go_annoCm_gene_clade, by = c("id" = "go_id")) %>% 
    left_join(input_path_df %>% dplyr::select(go_id2, log_p), by = c("id" = "go_id2"))
  
  ### Retrieve representative GO term for each cluster
  repr_GO = 
    # Retrieve ancestral GO terms for each GO term in go_id
    GO_anc[go_id] %>% stack() %>% `colnames<-`(c("ancestral", "go_id")) %>% 
    # rm 'all' -mk
    filter(ancestral != "all") %>% 
    # Add clusters from simplifyGO and count the number of times each ancestral GO appears in ancestral terms for each GO cluster
    left_join(dplyr::select(go_df2, c("cluster", "id", "n_genes", "n_genes_rescale", 
                                      "log_p", "n_clades")), by = setNames("id", "go_id")) %>%  # -mk: add n_genes
    group_by(cluster, ancestral) %>% add_count() %>% ungroup %>%  # n is the # of children for each ancestor
    # Add Information Content for each ancestral GO and calculate "importance" (most informative somewhat common ancestral GO term)
    mutate(IC = GO_semsim@IC[ancestral],
           IC_scale = scales::rescale(IC, to = c(1,10))) %>% 
    mutate(importance = (n*IC^2)) %>% 
    # Add Information Content for children as well -mk
    mutate(ICc = GO_semsim@IC[go_id],
           ICc_scale = scales::rescale(ICc, to = c(1,10))) %>% 
    mutate(importance_child = (log_p*ICc_scale*n_genes_rescale)) 
  
  repr_GO_anc = repr_GO %>% 
    dplyr::select(cluster, ancestral, n, IC, importance) %>% distinct() %>% 
    left_join(dplyr::select(GO_def, c("GOID","TERM")), by = c("ancestral" = "GOID")) %>% 
    # take 1 ancestor per cluster
    group_by(cluster) %>% 
    slice_max(order_by = importance, n = 1) 

  repr_GO_child = repr_GO %>% 
    dplyr::select(cluster, go_id, n_clades, n_genes, n_genes_rescale, log_p, ICc, ICc_scale, importance_child) %>% distinct() %>% 
    left_join(dplyr::select(GO_def, c("GOID","TERM")), by = c("go_id" = "GOID")) %>% 
    # x = repr_GO_child %>% filter(cluster == 2)
    # remove terms overlaps with anc
    filter(!go_id %in% repr_GO_anc$ancestral) %>% 
    # take 2 children per cluster
    group_by(cluster) %>% 
    # slice_max(order_by = importance_child, n = N_children, with_ties = FALSE) 
    slice_max(order_by = log_p, n = N_children, with_ties = FALSE) 
  
  repr_GO2 = repr_GO_anc %>% 
    full_join(repr_GO_child, by = "cluster", suffix = c("_anc", "_des")) %>% 
    dplyr::select(cluster, ancestral, TERM_anc, importance, go_id, TERM_des, importance_child) %>% 
    arrange(desc(importance), desc(importance_child))
  
  # Function to find matching elements
  find_ids <- function(n, df) {
    col_values <- df$id[df$id %in% df$id[df$cluster == n]]
    # return(paste(elements, collapse = ","))
    return(col_values) }
  
  find_pvalues <- function(n, df) {
    col_values <- df$padj[df$go_id2 %in% unlist(repr_GO2$gos[repr_GO2$cluster == n])]
    # return(paste(elements, collapse = ","))
    return(col_values)}
  
  find_pvalue_des <- function(goid, df) {
    col_values <- df$padj[df$go_id2 %in% goid ]
    # return(paste(elements, collapse = ","))
    return(col_values)}

  # Add new columns with all p-values and all GOs 
  repr_GO2$gos <- sapply(repr_GO2$cluster, find_ids, go_df)
  repr_GO2$pvalues <- sapply(repr_GO2$cluster, find_pvalues, input_path_df)
  repr_GO2$minpval <- sapply(repr_GO2$pvalues, min)
  repr_GO2$pvalue_desc <- sapply(repr_GO2$go_id, find_pvalue_des, input_path_df)
  
  # Concatenate each list of p-values and GOs into a comma-separated string
  repr_GO2$pvalues <- sapply(repr_GO2$pvalues, function(x) format(x, digits=4))
  repr_GO2$pvalues <- sapply(repr_GO2$pvalues, function(x) paste(x, collapse = ","))
  repr_GO2$gos <- sapply(repr_GO2$gos, function(x) paste(x, collapse = ","))
  
  repr_GO3_anc = repr_GO2 %>% 
    dplyr::select(-TERM_des, -importance_child, -importance, -go_id, -pvalue_desc) %>% distinct() %>% 
    dplyr::rename( TERM = TERM_anc, padj = minpval, go_id = ancestral) %>% 
    mutate(ori = "ancestral")
  
  repr_GO3_des = repr_GO2 %>% 
    dplyr::select(-TERM_anc, -ancestral, -importance, -importance_child, -gos, -pvalues, -minpval) %>% distinct() %>% 
    dplyr::rename( TERM = TERM_des, padj = pvalue_desc) %>% 
    mutate(ori = "descendent")
  repr_GO3 = repr_GO3_anc %>% bind_rows(repr_GO3_des) %>% 
    mutate(log_p = -log10(padj)) %>% 
    arrange(cluster, desc(ori), log_p)
  
  y = repr_GO3
  y_lab = unique(y$TERM)
  y$TERM = factor(y$TERM, y_lab)
  print(n_distinct(y$TERM))
  
  pal = brewer.pal(9, 'Reds')
  p3 = ggplot(y ) +
    geom_tile(aes(x = ori, 
                  y = TERM,
                  fill = log_p), color = 'black') +
    scale_x_discrete(expand = c(0,0,0.05,0)) +
    scale_y_discrete(expand = c(0,0,0,0)) +
    # facet_grid(.~ori, scales = "free", space = "free") +
    scale_fill_gradient(low = pal[2], high = "#dc2943ff", name = expression(-~log[10]~P), n.breaks = 4) +
    theme_m +
    theme_a; p3
  
  # p = cowplot::plot_grid(p3, p_term34, ncol= 2, scale = c(0.92, 1), align = 'v');
  # return(list(p, repr_GO))
  return(list(p3, repr_GO3))
}

plotFunc_path_size_go_byp = function(input_path_df, input_acc_criteria, N){
  # input_accset, input_padj
  # input_path_df = nectar_only  
  # input_acc_criteria = tmp_acc_criteria
  
  input_path_df = input_path_df %>% 
    mutate(go_id2 = gsub("_", ":", go_id)) # normal format
  go_id = input_path_df$go_id2
  
  ## cluster go
  mat_all <- GO_similarity(go_id, ont = "BP", db = 'org.Hs.eg.db')
  go_df <- simplifyGO(mat_all, plot = FALSE) 
  
  ## adding gene counts to go_df -mk
  cnee_gene_tmp = get_cneegene_4clades(input_acc_criteria) %>% 
    dplyr::select(-id) %>% distinct()
  go_annoCm_gene_clade = go_annoCm %>% 
    filter(go_id %in% go_df$id) %>% 
    left_join(cnee_gene_tmp) %>% 
    filter(!is.na(clade)) %>% 
    group_by(go_id) %>% 
    summarise(n_genes = n_distinct(gene),
              n_clades = n_distinct(clade)) %>% 
    ungroup() %>% 
    mutate(n_genes_rescale = scales::rescale(n_genes, to = c(1,10)))
  go_df2 = go_df %>% left_join(go_annoCm_gene_clade, by = c("id" = "go_id")) %>% 
    left_join(input_path_df %>% dplyr::select(go_id2, log_p), by = c("id" = "go_id2"))
  
  ### Retrieve representative GO term for each cluster
  repr_GO = 
    # Retrieve ancestral GO terms for each GO term in go_id
    GO_anc[go_id] %>% stack() %>% `colnames<-`(c("ancestral", "go_id")) %>% 
    # rm 'all' -mk
    filter(ancestral != "all") %>% 
    # Add clusters from simplifyGO and count the number of times each ancestral GO appears in ancestral terms for each GO cluster
    left_join(dplyr::select(go_df2, c("cluster", "id", "n_genes", "n_genes_rescale", 
                                      "log_p", "n_clades")), by = setNames("id", "go_id")) %>%  # -mk: add n_genes
    group_by(cluster, ancestral) %>% add_count() %>% ungroup %>%  # n is the # of children for each ancestor
    # Add Information Content for each ancestral GO and calculate "importance" (most informative somewhat common ancestral GO term)
    mutate(IC = GO_semsim@IC[ancestral],
           IC_scale = scales::rescale(IC, to = c(1,10))) %>% 
    mutate(importance = (n*IC^2)) %>% 
    # Add Information Content for children as well -mk
    mutate(ICc = GO_semsim@IC[go_id],
           ICc_scale = scales::rescale(ICc, to = c(1,10))) %>% 
    mutate(importance_child = (log_p*ICc_scale*n_genes_rescale)) 
  
  repr_GO_anc = repr_GO %>% 
    dplyr::select(cluster, ancestral, n, IC, importance) %>% distinct() %>% 
    left_join(dplyr::select(GO_def, c("GOID","TERM")), by = c("ancestral" = "GOID")) %>% 
    # take 1 ancestor per cluster
    group_by(cluster) %>% 
    slice_max(order_by = importance, n = 1) 

  repr_GO_child = repr_GO %>% 
    dplyr::select(cluster, go_id, n_clades, n_genes, n_genes_rescale, log_p, ICc, ICc_scale, importance_child) %>% distinct() %>% 
    left_join(dplyr::select(GO_def, c("GOID","TERM")), by = c("go_id" = "GOID")) %>% 
    # x = repr_GO_child %>% filter(cluster == 2)
    # remove terms overlaps with anc
    filter(!go_id %in% repr_GO_anc$ancestral) %>% 
    # take 2 children per cluster
    # group_by(cluster) %>% 
    # slice_max(order_by = importance_child, n = N_children, with_ties = FALSE) 
    slice_max(order_by = log_p, n = N, with_ties = FALSE) 
  
  y = repr_GO_child %>% arrange(log_p)
  y_lab = unique(y$TERM)
  y$TERM = factor(y$TERM, y_lab)
  print(n_distinct(y$TERM))
  
  pal = brewer.pal(9, 'Reds')
  p3 = ggplot(y ) +
    geom_tile(aes(x = 1, 
                  y = TERM,
                  fill = log_p), color = 'black') +
    scale_x_discrete(expand = c(0,0,0.05,0)) +
    scale_y_discrete(expand = c(0,0,0,0)) +
    # facet_grid(.~ori, scales = "free", space = "free") +
    scale_fill_gradient(low = pal[2], high = "#dc2943ff", name = expression(-~log[10]~P), n.breaks = 4) +
    theme_m +
    theme_a; p3
  
  # p = cowplot::plot_grid(p3, p_term34, ncol= 2, scale = c(0.92, 1), align = 'v');
  # return(list(p, repr_GO))
  return(list(p3, repr_GO3))
}


plotFunc_path_genelist_go = function(input_path_df, input_acc_criteria, tmp_goTerm){
  # input_path_df = interested
  # input_acc_criteria = "Loose"
  # tmp_goTerm = "zymogen activation"
  # tmp_goTerm = "mRNA processing"
  
  # input_accset, input_padj
   
  phyloaccgo_union = input_path_df %>% 
    mutate(go_id = gsub("_", ":", go_id)) %>% 
    dplyr::rename(accset = clade) %>%
    # dplyr::rename(clade = accset) %>% 
    # mutate(rank = n_distinct(clade)) %>% 
    mutate(log_p = -log10(pval_g)) %>% 
    dplyr::select(accset, go_id, goTerm, log_p) 

  go_annoCm = go_annoC %>% 
    mutate(go_id = gsub("_", ":", go_id)) %>% 
    dplyr::select(-ont, -goTerm) %>% 
    distinct()

  # input (nectar acc) cnees and their great gene assignment
  acccnees_to_path = get_cneegene_4clades(input_acc_criteria) %>% 
    dplyr::select(-id) %>% distinct() %>% 
    left_join(go_annoCm)

  phyloaccgo_with_gene = phyloaccgo_union %>%
    left_join(acccnees_to_path, by = c("go_id"))
  
  if(grepl('Control', input_acc_criteria)){
    tmp_clade_order = nonnectar_clade_order
  }else{  tmp_clade_order = nectar_clade_order }
  
  phyloaccgo_with_gene$clade =  factor(phyloaccgo_with_gene$clade, levels = tmp_clade_order)
  
  # v2: num cnee per term per clade
  geneCount = phyloaccgo_with_gene %>% 
    group_by(go_id, clade) %>% # per term per clade, how many (unique) cnees, (sum of all genes)
    mutate(n_genes_perclade_perterm = n_distinct(gene)) %>% 
    group_by(go_id) %>% 
    mutate(n_clades = n_distinct(clade),
           sum_gene = sum(n_genes_perclade_perterm)) 
  geneCount$clade <- factor(geneCount$clade, levels = tmp_clade_order)

  print(tmp_goTerm)
  z2 = geneCount %>% filter(grepl(tmp_goTerm, goTerm )) 
  z2 = z2[, c("gene", "clade")] %>% distinct() %>% 
    mutate(val = 1) %>% 
    pivot_wider(id_cols = gene, names_from = clade, values_from = val, values_fn = present, values_fill = 0) %>% 
    pivot_longer(cols = all_of(2):last_col(), names_to = 'clade') %>% 
    bind_cols(goTerm = tmp_goTerm ) %>% 
    mutate(clade = fct_relevel(clade, tmp_clade_order)) %>% 
    mutate(value = as.factor(value)) 
  z2$value = factor(z2$value, levels = c("0", "1"))
  
  p_term61 = z2 %>% ggplot() +
    # geom_point(aes(y = gene, x = clade), color = 'grey50', shape = 15) + # , shape = 15
    geom_tile(aes(y = gene, x = clade, fill = value), color = 'grey20') +
    facet_grid(goTerm~., scales = 'free', space = 'free', switch = 'y') +
    ggtitle(tmp_goTerm) +
    scale_x_discrete(expand = c(0,0)) +
    scale_y_discrete(position = 'right', limits=rev, expand = c(0,0)) +
    scale_fill_manual(values = c("transparent", "grey70"),
                      na.translate = F, drop = F) +
    theme_m + 
    theme_a + theme(strip.text = element_blank(), plot.title = element_text(hjust = 0),
                    axis.text.y = element_text(face="italic")); p_term61
  
}

```


## gene list function
```{r}

outputFunc_go_table_4clades = function(input_path_df, input_acc_criteria){
  # input_accset, input_padj
  # input_path_df = nectar_only
  # input_acc_criteria = "ControlLoose"
  
  phyloaccgo_union = input_path_df %>% 
    ungroup() %>% 
    mutate(go_id = gsub("_", ":", go_id)) %>% 
    # dplyr::rename(clade = accset) %>% 
    mutate(rank = n_distinct(clade)) %>% 
    dplyr::select(clade, ont, go_id, goTerm, pval_g, padj, q:k, pval_h, padj_h) %>% distinct()
  
  go_annoCm = go_annoC %>%
    mutate(go_id = gsub("_", ":", go_id)) %>%
    dplyr::select(-ont, -goTerm) %>%
    distinct()

  # input (nectar acc) cnees and their great gene assignment
  acccnees_to_path = get_cneegene_4clades(input_acc_criteria) %>% 
    dplyr::select(-id) %>% distinct() %>% left_join(go_annoCm)
  
  phyloaccgo_with_gene = phyloaccgo_union %>%
    left_join(acccnees_to_path, by = c("go_id", "clade")) %>% 
    dplyr::rename(ontology = ont) %>% 
    dplyr::rename(ID = go_id, 
                  Term = goTerm,
                  # `-logP_great` = log_p,
                  # `-log(q-value)_great` = log_q,
                  # `-logP_hypergeometric` = log_ph,
                  # `-log(q-value)_hypergeometric` = log_qh
                  pvalue_binomial = pval_g,
                  p.adj_binomial = padj,
                  pvalue_hypergeometric = pval_h,
                  p.adj_hypergeometric = padj_h
                  ) %>% distinct() %>% 
    mutate(pvalue_binomial = signif(pvalue_binomial, digits = 2),
           p.adj_binomial = signif(p.adj_binomial, digits = 2),
           pvalue_hypergeometric = signif(pvalue_hypergeometric, digits = 2),
           p.adj_hypergeometric = signif(pvalue_binomial, digits = 2)) %>% 
    group_by(ID, clade) %>% 
    mutate(Count = n_distinct(gene), 
           Hits = paste0(sort(unique(gene)), collapse = "|")) %>% 
    dplyr::select(-gene) %>% distinct() %>% 
    arrange(ID, clade) %>% 
    dplyr::select(ontology, ID, Term, clade, pvalue_binomial:Hits)
}

outputFunc_go_table_convergent = function(input_path_df, input_acc_criteria){
  # input_accset, input_padj
  # input_path_df = nectar_only
  # input_acc_criteria = "ControlLoose"
  
  phyloaccgo_union = input_path_df %>% 
    ungroup() %>% 
    mutate(go_id = gsub("_", ":", go_id)) %>% 
    # dplyr::rename(clade = accset) %>% 
    mutate(rank = n_distinct(clade)) %>% 
    dplyr::select(ont, go_id, goTerm, pval_g, padj, q:k, pval_h, padj_h) %>% distinct()
  
  go_annoCm = go_annoC %>%
    mutate(go_id = gsub("_", ":", go_id)) %>%
    dplyr::select(-ont, -goTerm) %>%
    distinct()

  # input (nectar acc) cnees and their great gene assignment
  acccnees_to_path = get_cneegene_4clades(input_acc_criteria) %>% 
    dplyr::select(-id) %>% distinct() %>% left_join(go_annoCm)
  
  phyloaccgo_with_gene = phyloaccgo_union %>%
    left_join(acccnees_to_path, by = c("go_id")) %>% 
    dplyr::rename(ontology = ont) %>% 
    dplyr::rename(ID = go_id, 
                  Term = goTerm,
                  # `-logP_great` = log_p,
                  # `-log(q-value)_great` = log_q,
                  # `-logP_hypergeometric` = log_ph,
                  # `-log(q-value)_hypergeometric` = log_qh
                  pvalue_binomial = pval_g,
                  p.adj_binomial = padj,
                  pvalue_hypergeometric = pval_h,
                  p.adj_hypergeometric = padj_h
                  ) %>% distinct() %>% 
    mutate(pvalue_binomial = signif(pvalue_binomial, digits = 2),
           p.adj_binomial = signif(p.adj_binomial, digits = 2),
           pvalue_hypergeometric = signif(pvalue_hypergeometric, digits = 2),
           p.adj_hypergeometric = signif(pvalue_binomial, digits = 2)) %>% 
    group_by(ID, clade) %>% 
    mutate(Count = n_distinct(gene), 
           Hits = paste0(sort(unique(gene)), collapse = "|")) %>% 
    dplyr::select(-gene) %>% distinct() %>% 
    arrange(ID, clade) %>% 
    dplyr::select(ontology, ID, Term, clade, pvalue_binomial:Hits)
}
```


#### NECTAR
##### congvergent_gteq2way [fdr] - rm control
```{r, fig.height=3, fig.width=3}

# nectar
tmp_acc_criteria = "Loose"
tmp_accset = "congvergent_gteq2way"

# remove control >=2 clade
nectar = loose_hypo_marked %>% filter(clade == tmp_accset) %>% 
  filter(sig == "*")
n_distinct(nectar$go_id)
nectar_only = nectar %>% filter(!go_id %in% conloose_hypo_onlyoverlap_gteq2$go_id)
n_distinct(nectar_only$go_id)
  
l = list('nectar' = unique(nectar$goTerm), 
         'control>=2clades' = unique(conloose_hypo_onlyoverlap_gteq2$goTerm))
ggvenn::ggvenn(l) # 168


l = list('nectar only' = unique(nectar_only$goTerm), 
         'willbefilteredout' = unique(go_annoC_filtered_pathwayonly_only$goTerm))
ggvenn::ggvenn(l) # 168
intersect(nectar_only$goTerm, go_annoC_filtered_pathwayonly_only$goTerm) 


# get genes 
tmp_genes = acccnees_100kb_withcnees0_loose %>% filter(group == tmp_accset)
tmp_go_anno = go_annoC %>% filter(go_id %in% nectar_only$go_id) %>% 
  # keep only genes in the set
  filter(gene %in% tmp_genes$gene) %>% 
  group_by(go_id) %>% 
  summarise(n_genes = n_distinct(gene)) %>% 
  # keep only go_id with num observed gene >=3 # <---
  filter(n_genes >=3 )

nectar_only_filtered = nectar_only %>% 
  # keep only go_id with num observed gene >=3 # <---
  filter(go_id %in% tmp_go_anno$go_id)
n_distinct(nectar_only_filtered$go_id)

# output enrichment
tb = outputFunc_go_table_convergent(input_path_df = nectar_only_filtered, input_acc_criteria = tmp_acc_criteria) 

path = paste0(out_dir, "GO_", fdr_flag,"_", tmp_acc_criteria, "_", tmp_accset, "_rep_nocontrol_withgene_greathypogeometric_enrichmentresult_", Sys.Date(), ".csv")
# write_csv(tb, file = path)


# plot 1: 
pl = plotFunc_path_size_go(input_path_df = nectar_only_filtered, input_acc_criteria = tmp_acc_criteria) 

graph_path = paste0(out_dir, "GO_", fdr_flag,"_", tmp_acc_criteria, "_", tmp_accset, "_rep_nocontrol_withgene_greathypogeometric_p1_", Sys.Date(), ".pdf")
pdf(graph_path, width = Width_HalfCol*3.3, height = Width_HalfCol*1, pointsize = AxisTxFontSizeSize, onefile = TRUE)
pl
dev.off()

```

###### gene list2
```{r}

# l = unique(tb$Term)
l = c("metabolic process", "steroid metabolic process", "electron transport chain")

interested = nectar_only_filtered %>% 
  filter(goTerm %in% l) %>% 
  mutate(go_id2 = gsub("_", ":", go_id)) #%>%
  # filter(go_id2 %in% tb$ID)
  # filter(goTerm %in% l)
ind = sapply(l, function(s){grep(s, interested$goTerm)[1]})
interested = interested[ind,]
n_distinct(interested$goTerm)
# interested$goTerm = factor(interested$goTerm, levels = y_lab) # decide sorting outside of the function

## gene list
tmp_acc_criteria = "Loose"
pl2 = mapply(plotFunc_path_genelist_go, 
             input_path_df = list(interested), 
             input_acc_criteria = tmp_acc_criteria, 
             tmp_goTerm = l, SIMPLIFY = F)

# p = cowplot::plot_grid(plotlist = pl2, ncol = 1,
#                        rel_heights = c(1, 2.2, 1.7, 1.2, 1.9, 
#                                        0.9, 1, 2, 0.8, 1, 
#                                        1, 0.9, 0.7, 3.9, 1.5,
#                                        1.4, 1.5, 1.5)); p


p = cowplot::plot_grid(plotlist = pl2, ncol = 1,
                       rel_heights = c(2, 1, 1))

graph_path = paste0(out_dir, "GO_", fdr_flag,"_", tmp_acc_criteria, "_", 
                    paste0(nectar_clade_order, collapse = "_"), "_rep_nocontrol_withgene_greathypogeometric_p1_genelist_", 
                    Sys.Date(), ".pdf")
pdf(graph_path, width = Width_HalfCol*0.7, height = Width_HalfCol*1.7*length(l), pointsize = AxisTxFontSizeSize, onefile = TRUE)
p
dev.off()

```


##### individual clade [fdr] - rm control, >= 3
```{r, fig.height=3, fig.width=3}

# nectar
tmp_acc_criteria = "Loose"
tmp_accset = nectar_clade_order

# remove control >=2 clade
nectar = loose_hypo_marked %>% filter(clade %in% tmp_accset) %>% 
  filter(sig == "*") # only great hypo overlap
n_distinct(nectar$go_id)
nectar_only = nectar %>% filter(!go_id %in% conloose_hypo_onlyoverlap_gteq2$go_id)
n_distinct(nectar_only$go_id)
  
l = list('nectar' = unique(nectar$goTerm), 
         'control>=2clades' = unique(conloose_hypo_onlyoverlap_gteq2$goTerm))
ggvenn::ggvenn(l) 

# pathway lv convergent n>=3
nectar_only2 = nectar_only %>% 
  group_by(go_id) %>% 
  mutate(n_clades = n_distinct(clade)) %>% 
  filter(n_clades >= 3) %>% 
  mutate(go_id2 = gsub("_", ":", go_id))
n_distinct(nectar_only2$go_id) # 4 clades: 0; 3 clades: 4

# plot
## cluster go
go_id = nectar_only2$go_id2
mat_all <- GO_similarity(go_id, ont = "BP", db = 'org.Hs.eg.db')
go_df <- simplifyGO(mat_all, plot = FALSE) 

tmp =  nectar_only2 %>% 
  left_join(go_df, by = c("go_id2" = "id")) %>% 
  mutate(log_p = -log10(padj)) %>%
  ungroup() %>% 
  complete(clade, goTerm) # complete: pay attention to group_by
n_distinct(tmp$goTerm) # 4

y = tmp %>% ungroup() %>% arrange(desc(n_clades), clade) # , , clade
# x = y %>% dplyr::select(cluster, goTerm) %>% distinct() %>% filter(!is.na(cluster))
y_lab = unique(y$goTerm)
y$goTerm = factor(y$goTerm, y_lab)
y$clade = factor(y$clade, nectar_clade_order)

pal = brewer.pal(9, 'Reds')
p3 = ggplot( y ) +
  geom_tile(aes(x = clade, #y = fct_relevel(lab, levels(x3)), 
                y = goTerm,
                fill = log_p), color = 'white') +
  # geom_text(aes(label = sig, x = clade, y = ancestral), hjust = 0.5, vjust = 0.75) +
  scale_x_discrete(expand = c(0,0,0.05,0)) +
  scale_y_discrete(expand = c(0,0,0,0)) +
  # facet_grid(facets = group+ont~., space = 'free', scale = 'free') +
  # scale_fill_manual(values = pal1) +
  scale_color_manual(values = c('black', 'white')) +
  scale_fill_gradient(low = pal[2], high = "#dc2943ff", name = expression(-~log[10]~P), 
                      # breaks = c(2,4), 
                      na.value = 'grey90', n.breaks = 4) +
  # labs(x=expression(-~log[10]~P)) +
  guides(fill = guide_colorbar(direction = 'horizontal')) +
  theme_m +
  theme_a + theme(legend.position = 'bottom'); p3

graph_path = paste0(out_dir, "GO_", fdr_flag,"_", tmp_acc_criteria, "_", 
                    paste0(nectar_clade_order, collapse = "_"), "_nocontrol_greathypogeometric_nclades3_", Sys.Date(), ".pdf")
pdf(graph_path, width = Width_HalfCol*0.975, height = Width_HalfCol*0.6, pointsize = AxisTxFontSizeSize, onefile = TRUE)
p3
dev.off()


```

###### STABLE
```{r}
# output enrichment

tb = outputFunc_go_table_4clades(input_path_df = nectar_only2, input_acc_criteria = tmp_acc_criteria) # all n_genes >=3

path = paste0(out_dir, "GO_", fdr_flag,"_", tmp_acc_criteria, "_", paste0(nectar_clade_order, collapse = "_"), "_nocontrol_greathypogeometric_nclades3_enrichmentresult_", Sys.Date(), ".csv")
write_csv(tb, file = path)

```

###### plot CNEE-gene circles
```{r}

interested = nectar_only %>% 
  mutate(go_id2 = gsub("_", ":", go_id)) %>%
  filter(go_id2 %in% tb$ID) 
interested$goTerm = factor(interested$goTerm, levels = y_lab) # decide sorting outside of the function

pl = plotFunc_path_size_only_go(input_path_df = interested, input_acc_criteria = tmp_acc_criteria) 
pl

graph_path = paste0(out_dir, "GO_", fdr_flag,"_", tmp_acc_criteria, "_", 
                    paste0(nectar_clade_order, collapse = "_"), "_nocontrol_greathypogeometric_nclades3_circle_", Sys.Date(), ".pdf")
pdf(graph_path, width = Width_HalfCol*1.4, height = Width_HalfCol*0.425, pointsize = AxisTxFontSizeSize, onefile = TRUE)
pl
dev.off()

```

###### gene list
```{r}

l = c("regulation of blood pressure", "protein homooligomerization", "cellular response to leukemia inhibitory factor",
      "regulation of actin cytoskeleton organization", "RNA splicing")

interested = nectar_only %>% 
  mutate(go_id2 = gsub("_", ":", go_id)) %>%
  filter(go_id2 %in% tb$ID) 
interested$goTerm = factor(interested$goTerm, levels = y_lab) # decide sorting outside of the function

## gene list
tmp_acc_criteria = "Loose"
pl2 = mapply(plotFunc_path_genelist_go, 
             input_path_df = list(interested), 
             input_acc_criteria = tmp_acc_criteria, 
             tmp_goTerm = l, SIMPLIFY = F)

p = cowplot::plot_grid(plotlist = pl2, ncol = 1, 
                       rel_heights = c(1, 1.4, 1.7, 1, 2)); p

graph_path = paste0(out_dir, "GO_", fdr_flag,"_", tmp_acc_criteria, "_", 
                    paste0(nectar_clade_order, collapse = "_"), "_nocontrol_greathypogeometric_nclades3_genelist_", Sys.Date(), ".pdf")
pdf(graph_path, width = Width_HalfCol*0.7, height = Width_HalfCol*1.55*length(l), pointsize = AxisTxFontSizeSize, onefile = TRUE)
p
dev.off()

```



#### CONTROL
##### congvergent_gteq2way [fdr] - rm nectar
```{r, fig.height=3, fig.width=3}
unique(conloose_hypo_marked$acc_criteria)
unique(conloose_hypo_marked$clade)

# control
tmp_acc_criteria = "ControlLoose"
tmp_accset = "congvergent_gteq2way"

# remove control >=2 clade
control = conloose_hypo_marked %>% filter(clade == tmp_accset) %>% 
  filter(sig == "*")
n_distinct(control$go_id)
control_only = control %>% filter(!go_id %in% loose_hypo_onlyoverlap_gteq2$go_id)
n_distinct(control_only$go_id)
  
l = list('control' = unique(control$goTerm), 
         'nectar>=2clades' = unique(loose_hypo_onlyoverlap_gteq2$goTerm))
ggvenn::ggvenn(l) # 168


l = list('control only' = unique(control_only$goTerm), 
         'willbefilteredout' = unique(go_annoC_filtered_pathwayonly_only$goTerm))
ggvenn::ggvenn(l) 
intersect(control_only$goTerm, go_annoC_filtered_pathwayonly_only$goTerm) # 0 good

# get genes 
tmp_genes = acccnees_100kb_withcnees0_looseCon %>% filter(group == tmp_accset)
tmp_go_anno = go_annoC %>% filter(go_id %in% control_only$go_id) %>% 
  # keep only genes in the set
  filter(gene %in% tmp_genes$gene) %>% 
  group_by(go_id) %>% 
  summarise(n_genes = n_distinct(gene)) %>% 
  # keep only go_id with num observed gene >=3 # <---
  filter(n_genes >=3 )

control_only_filtered = control_only %>% 
  # keep only go_id with num observed gene >=3 # <---
  filter(go_id %in% tmp_go_anno$go_id)
n_distinct(control_only_filtered$go_id)

# output enrichment
tb = outputFunc_go_table_convergent(input_path_df = control_only_filtered, input_acc_criteria = tmp_acc_criteria) 

path = paste0(out_dir, "GO_", fdr_flag,"_", tmp_acc_criteria, "_", tmp_accset, "_rep_nocontrol_withgene_greathypogeometric_enrichmentresult_", Sys.Date(), ".csv")
# write_csv(tb, file = path)


# plot 1: 
pl = plotFunc_path_size_go(input_path_df = control_only_filtered, input_acc_criteria = tmp_acc_criteria) 

graph_path = paste0(out_dir, "GO_", fdr_flag,"_", tmp_acc_criteria, "_", tmp_accset, "_rep_nocontrol_withgene_greathypogeometric_p1_", Sys.Date(), ".pdf")
pdf(graph_path, width = Width_HalfCol*3, height = Width_HalfCol*0.325, pointsize = AxisTxFontSizeSize, onefile = TRUE)
pl
dev.off()


```

##### individual clade [fdr] - rm nectar, >= 3
```{r, fig.height=3, fig.width=3}

# control
tmp_acc_criteria = "ControlLoose"
tmp_accset = nonnectar_clade_order

# remove control >=2 clade
control = conloose_hypo_marked %>% filter(clade == tmp_accset) %>% 
  filter(sig == "*")
n_distinct(control$go_id)
control_only = control %>% filter(!go_id %in% loose_hypo_onlyoverlap_gteq2$go_id)
n_distinct(control_only$go_id)

l = list('control' = unique(control$goTerm), 
         'nectar>=2clades' = unique(loose_hypo_onlyoverlap_gteq2$goTerm))
ggvenn::ggvenn(l) 


l = list('control only' = unique(control_only$goTerm), 
         'willbefilteredout' = unique(go_annoC_filtered_pathwayonly_only$goTerm))
ggvenn::ggvenn(l) 
intersect(control_only$goTerm, go_annoC_filtered_pathwayonly_only$goTerm) # 0 good


# pathway lv convergent n>=3
control_only$clade = factor(control_only$clade, nonnectar_clade_order)
control_only2 = control_only %>% 
  group_by(go_id) %>% 
  mutate(n_clades = n_distinct(clade)) %>% 
  filter(n_clades >= 3) %>%
  mutate(go_id2 = gsub("_", ":", go_id))
n_distinct(control_only2$go_id) # 4 clades: 0; 3 clades: 0; 

# plot
## cluster go
go_id = control_only2$go_id2
mat_all <- GO_similarity(go_id, ont = "BP", db = 'org.Hs.eg.db')
go_df <- simplifyGO(mat_all, plot = FALSE) 

tmp =  control_only2 %>% 
  # left_join(go_df, by = c("go_id2" = "id")) %>% 
  mutate(log_p = -log10(padj)) %>%
  ungroup() %>% 
  complete(clade, goTerm) # complete: pay attention to group_by
n_distinct(tmp$goTerm) # 0

y = tmp %>% ungroup() %>% arrange(n_clades, clade) # , , clade
# x = y %>% dplyr::select(cluster, goTerm) %>% distinct() %>% filter(!is.na(cluster))
y_lab = unique(y$goTerm)
y$goTerm = factor(y$goTerm, y_lab)
y$clade = factor(y$clade, nonnectar_clade_order)

pal = brewer.pal(9, 'Reds')
p3 = ggplot( y ) +
  geom_tile(aes(x = clade, #y = fct_relevel(lab, levels(x3)), 
                y = goTerm,
                fill = log_p), color = 'white') +
  # geom_text(aes(label = sig, x = clade, y = ancestral), hjust = 0.5, vjust = 0.75) +
  scale_x_discrete(expand = c(0,0,0.05,0)) +
  scale_y_discrete(expand = c(0,0,0,0)) +
  # facet_grid(facets = group+ont~., space = 'free', scale = 'free') +
  # scale_fill_manual(values = pal1) +
  scale_color_manual(values = c('black', 'white')) +
  scale_fill_gradient(low = pal[2], high = "#dc2943ff", name = expression(-~log[10]~P), 
                      # breaks = c(2,4), 
                      na.value = 'grey90', n.breaks = 4) +
  # labs(x=expression(-~log[10]~P)) +
  # guides(fill = guide_colorbar(direction = 'horizontal')) +
  theme_m +
  theme_a + theme(legend.position = 'right'); p3

graph_path = paste0(out_dir, "GO_", fdr_flag,"_", tmp_acc_criteria, "_", 
                    paste0(nectar_clade_order, collapse = "_"), "_nocontrol_greathypogeometric_nclades3_", Sys.Date(), ".pdf")
# pdf(graph_path, width = Width_HalfCol*1.6, height = Width_HalfCol*1, pointsize = AxisTxFontSizeSize, onefile = TRUE)
pdf(graph_path, width = Width_HalfCol*1.5, height = Width_HalfCol*0.45, pointsize = AxisTxFontSizeSize, onefile = TRUE)
p3
dev.off()


```